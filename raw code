--[[
    ╔═══════════════════════════════════════╗
    ║          LITHIUM HUB v0.0.3           ║
    ║         (Alpha) - PERFECT             ║
    ╚═══════════════════════════════════════╝
]]

print("Initializing Lithium Hub...")

-- ═══════════════════════════════════════
-- LOGO CONFIGURATION
-- ═══════════════════════════════════════

local LOGO_IMAGE_ID = "rbxassetid://77974635495294"

-- ═══════════════════════════════════════
-- ✅ КРИТИЧНО! ЖДЁМ И НАЖИМАЕМ КНОПКИ СРАЗУ!
-- ═══════════════════════════════════════

repeat task.wait() until game:IsLoaded() and game:GetService("Players").LocalPlayer

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

repeat task.wait() until game:IsLoaded() and game:GetService("Players").LocalPlayer

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- ✅ ДОБАВЬ СЮДА CONFIG - ДО ИСПОЛЬЗОВАНИЯ!
local Config = {
    FullStory = false,
    FullStoryState = "idle",
    ServerHop = false,
    MobFarm = false,
    SelectedMob = "Security Guard",
    StandFarm = false,
    MinArrows = 25,
    MinRokas = 25,
    TargetStand = "The World",
    StopOnSkin = true,
    PlayerFarm = false,
    TargetPlayer = nil,
    ItemAutofarm = false,
    ItemServerHop = false,
    SelectedItems = {},
    AutoSell = false,
    SellItems = {},
    AutoBuyArrows = false,
    PlayerESP = false,
    ShowDistance = true,
    SkinSearch = false,
    TargetSkin = "None",
    CustomSkin = "",
    StandList = {
        ["The World"] = true,
        ["Star Platinum"] = true,
        ["Star Platinum: The World"] = true,
        ["Crazy Diamond"] = true,
        ["King Crimson"] = true,
        ["King Crimson Requiem"] = true
    },
    WaitUntilCollect = 0.6,
    SortOrder = "Asc",
    LessPing = false,
    AutoRequiem = false,
    NPCTimeOut = 15,
    HamonCharge = 90,
    Webhook = "",
    AutoSBR = false,
    SBRMode = "Normal",
    JoinSBR = false
}

local ConfigFile = "LithiumHubConfig.json"

local function ApplyPreConfig()
    if not _G.LithiumConfig then 
        return 
    end
    
    print("[Lithium] ═══════════════════════════════")
    print("[Lithium] Applying pre-configuration...")
    
    for key, value in pairs(_G.LithiumConfig) do
        if Config[key] ~= nil then
            Config[key] = value
            
            if type(value) == "table" then
                if #value > 0 then
                    print(string.format("  ✓ %s = {%s}", key, table.concat(value, ", ")))
                else
                    print(string.format("  ✓ %s = {}", key))
                end
            else
                print(string.format("  ✓ %s = %s", key, tostring(value)))
            end
        end
    end
    
    print("[Lithium] ✓ Pre-config applied!")
    print("[Lithium] ═══════════════════════════════")
    
    _G.LithiumConfig = nil
end

ApplyPreConfig()

local function SaveConfig()
    local success, err = pcall(function()
        local configData = game:GetService("HttpService"):JSONEncode(Config)
        writefile(ConfigFile, configData)
        print("[Lithium] Config saved!")
    end)
    if not success then
        warn("[Lithium] Failed to save config:", err)
    end
end

local function LoadConfig()
    local success, err = pcall(function()
        if isfile(ConfigFile) then
            local configData = readfile(ConfigFile)
            local loadedConfig = game:GetService("HttpService"):JSONDecode(configData)
            
            for key, value in pairs(loadedConfig) do
                if key ~= "StandList" then
                    Config[key] = value
                end
            end
            
            print("[Lithium] Config loaded!")
        else
            print("[Lithium] No saved config found, using defaults")
        end
    end)
    if not success then
        warn("[Lithium] Failed to load config:", err)
    end
end

LoadConfig()

-- ═══════════════════════════════════════
-- КОНФИГУРАЦИЯ SBR
-- ═══════════════════════════════════════

local SBR_CONFIG = {
    -- Позиция ожидания (nil = автопоиск NYC Bridge Part)
    SafeWaitPosition = nil,
    
    -- Размер платформы ожидания
    PlatformSize = Vector3.new(25, 1, 25),
    PlatformOffset = -5,
    
    -- Координаты финиша (nil = автопоиск)
    FinishPosition = nil,
    
    -- Задержка перед телепортом на финиш
    WaitBeforeFinish = 10,
    
    -- Настройки плавного телепорта
    TeleportStepSize = 20,
    TeleportStepDelay = 0.03,
    TeleportPlatformSize = Vector3.new(10, 1, 10),
}

-- ═══════════════════════════════════════
-- ПОИСК ПАРТА НА NYC BRIDGE (УЛУЧШЕННЫЙ)
-- ═══════════════════════════════════════

local function FindNYCBridgePart()
    print("[SBR] Searching for NYC Bridge Part...")
    
    local success, result = pcall(function()
        local map = workspace:FindFirstChild("Map")
        if not map then
            warn("[SBR] Map not found!")
            return nil
        end
        
        local nycBridge = map:FindFirstChild("NYC Bridge")
        if not nycBridge then
            warn("[SBR] NYC Bridge not found!")
            return nil
        end
        
        local bridge = nycBridge:FindFirstChild("NYCBridge")
        if not bridge then
            warn("[SBR] NYCBridge not found!")
            return nil
        end
        
        local main = bridge:FindFirstChild("Main")
        if not main then
            warn("[SBR] Main not found!")
            return nil
        end
        
        print("[SBR] Searching through Main children...")
        
        -- ✅ ИЩЕМ ПО КОМБИНАЦИИ: РАЗМЕР + ЦВЕТ + РОТАЦИЯ
        for _, child in pairs(main:GetChildren()) do
            if child:IsA("Model") then
                for _, part in pairs(child:GetChildren()) do
                    if part:IsA("BasePart") and part.Name == "Part" then
                        local size = part.Size
                        local color = part.Color
                        local rotation = part.Rotation
                        local pos = part.Position
                        
                        -- Проверяем размер (9, 505, 9)
                        local sizeMatch = math.abs(size.X - 9) < 1 and 
                                         math.abs(size.Y - 505) < 10 and 
                                         math.abs(size.Z - 9) < 1
                        
                        -- Проверяем цвет Burgundy [136, 62, 62]
                        local colorMatch = math.abs(color.R * 255 - 136) < 10 and
                                          math.abs(color.G * 255 - 62) < 10 and
                                          math.abs(color.B * 255 - 62) < 10
                        
                        -- Проверяем ротацию (~75 градусов по X)
                        local rotationMatch = math.abs(rotation.X - 75) < 10
                        
                        -- Проверяем высоту (Y ~553)
                        local heightMatch = pos.Y > 500 and pos.Y < 600
                        
                        -- ✅ ВСЕ УСЛОВИЯ ДОЛЖНЫ СОВПАСТЬ!
                        if sizeMatch and colorMatch and rotationMatch and heightMatch then
                            print("[SBR] ✓ Found UNIQUE NYC Bridge Part!")
                            print(string.format("[SBR] - Position: %.1f, %.1f, %.1f", 
                                pos.X, pos.Y, pos.Z))
                            print(string.format("[SBR] - Size: %.1f, %.1f, %.1f", 
                                size.X, size.Y, size.Z))
                            print(string.format("[SBR] - Color: %.0f, %.0f, %.0f", 
                                color.R * 255, color.G * 255, color.B * 255))
                            print(string.format("[SBR] - Rotation: %.1f, %.1f, %.1f", 
                                rotation.X, rotation.Y, rotation.Z))
                            
                            return part
                        end
                    end
                end
            end
        end
        
        warn("[SBR] NYC Bridge Part not found by unique combination!")
        return nil
    end)
    
    if success and result then
        return result
    else
        warn("[SBR] Error searching for NYC Bridge Part:", result)
        return nil
    end
end

-- ═══════════════════════════════════════
-- ПЛАВНЫЙ ТЕЛЕПОРТ С ПЛАТФОРМОЙ
-- ═══════════════════════════════════════

local function smoothTeleport(targetPosition, stepSize, stepDelay)
    stepSize = stepSize or SBR_CONFIG.TeleportStepSize
    stepDelay = stepDelay or SBR_CONFIG.TeleportStepDelay
    
    local Character = LocalPlayer.Character
    local HRP = Character and Character:FindFirstChild("HumanoidRootPart")
    
    if not HRP then
        warn("[SBR] No HumanoidRootPart for smooth teleport!")
        return false
    end
    
    local startPos = HRP.Position
    local distance = (targetPosition - startPos).Magnitude
    local steps = math.ceil(distance / stepSize)
    
    print("[SBR] ═══════════════════════════════")
    print(string.format("[SBR] Smooth teleport with platforms:"))
    print(string.format("[SBR] - Distance: %.1f studs", distance))
    print(string.format("[SBR] - Steps: %d x %.1f studs", steps, stepSize))
    print(string.format("[SBR] - ETA: ~%.1f sec", steps * stepDelay))
    print("[SBR] ═══════════════════════════════")
    
    local currentPlatform = nil
    
    for i = 1, steps do
        local success = pcall(function()
            Character = LocalPlayer.Character
            HRP = Character and Character:FindFirstChild("HumanoidRootPart")
            
            if not HRP then
                warn(string.format("[SBR] Lost HRP at step %d/%d", i, steps))
                return
            end
            
            local currentPos = HRP.Position
            local direction = (targetPosition - currentPos).Unit
            local remainingDistance = (targetPosition - currentPos).Magnitude
            
            -- Вычисляем следующую позицию
            local nextPos
            if remainingDistance <= stepSize then
                nextPos = targetPosition
            else
                nextPos = currentPos + (direction * stepSize)
            end
            
            -- ✅ УДАЛЯЕМ СТАРУЮ ПЛАТФОРМУ
            if currentPlatform and currentPlatform.Parent then
                currentPlatform:Destroy()
            end
            
            -- ✅ СОЗДАЁМ НОВУЮ ПЛАТФОРМУ ПОД СЛЕДУЮЩЕЙ ПОЗИЦИЕЙ
            currentPlatform = Instance.new("Part")
            currentPlatform.Name = "SBRStepPlatform"
            currentPlatform.Parent = workspace
            currentPlatform.Anchored = true
            currentPlatform.Size = SBR_CONFIG.TeleportPlatformSize
            currentPlatform.Position = nextPos - Vector3.new(0, 5, 0)  -- 5 стадов ниже
            currentPlatform.Transparency = 1
            currentPlatform.CanCollide = true
            
            -- ✅ ТЕЛЕПОРТИРУЕМСЯ
            task.wait(0.05)  -- Даём платформе загрузиться
            HRP.CFrame = CFrame.new(nextPos)
            
            -- Логируем прогресс
            if i % 5 == 0 or remainingDistance <= stepSize then
                print(string.format("[SBR] Step %d/%d (%.1f studs left)", 
                    i, steps, remainingDistance))
            end
            
            -- Если достигли цели - выходим
            if remainingDistance <= stepSize then
                print(string.format("[SBR] ✓ Destination reached (step %d/%d)", i, steps))
                return
            end
        end)
        
        if not success then
            warn(string.format("[SBR] Step %d failed", i))
        end
        
        task.wait(stepDelay)
    end
    
    -- ✅ ФИНАЛЬНАЯ КОРРЕКЦИЯ
    pcall(function()
        Character = LocalPlayer.Character
        HRP = Character and Character:FindFirstChild("HumanoidRootPart")
        if HRP then
            HRP.CFrame = CFrame.new(targetPosition)
        end
    end)
    
    task.wait(0.5)
    
    -- ✅ УДАЛЯЕМ ПОСЛЕДНЮЮ ПЛАТФОРМУ
    if currentPlatform and currentPlatform.Parent then
        currentPlatform:Destroy()
    end
    
    print("[SBR] ✓ Smooth teleport completed!")
    return true
end

-- ═══════════════════════════════════════
-- PLAYER FOLLOWING FUNCTIONS
-- ═══════════════════════════════════════

local function GetAlivePlayers()
    local alivePlayers = {}
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            local humanoid = player.Character:FindFirstChild("Humanoid")
            local hrp = player.Character:FindFirstChild("HumanoidRootPart")
            
            if humanoid and hrp and humanoid.Health > 0 then
                table.insert(alivePlayers, player)
            end
        end
    end
    
    table.sort(alivePlayers, function(a, b)
        return a.Name < b.Name
    end)
    
    return alivePlayers
end


-- ✅ 2. ФУНКЦИЯ: Проверка HP игрока
local function GetPlayerHealthPercent(player)
    if not player or not player.Character then return 0 end
    
    local humanoid = player.Character:FindFirstChild("Humanoid")
    if not humanoid then return 0 end
    
    return (humanoid.Health / humanoid.MaxHealth) * 100
end
-- ═══════════════════════════════════════
-- ЗАМЕНИ ФУНКЦИЮ FollowPlayer НА ЭТУ:
-- ═══════════════════════════════════════

local function followPlayerPrecise(player, duration)
    print(string.format("[SBR] Following player (precise): %s", player.Name))
    
    -- ✅ КРИТИЧНО! Обновляем Character и HRP В НАЧАЛЕ!
    local Character = LocalPlayer.Character
    if not Character then
        warn("[SBR] No character found!")
        return false
    end
    
    local HRP = Character:FindFirstChild("HumanoidRootPart")
    if not HRP then
        warn("[SBR] No HumanoidRootPart found!")
        return false
    end
    
    local Target = player.Character
    if not Target or not Target:FindFirstChild("HumanoidRootPart") then
        warn("[SBR] Target has no character/HRP!")
        return false
    end
    
    print(string.format("[SBR] ✓ Character and HRP validated"))
    
    local startTime = tick()
    local beingTargeted = true
    local playerDistance = 15
    
    local function setStandMorphPosition()
        pcall(function()
            if not Target or not Target:FindFirstChild("HumanoidRootPart") then 
                print("[SBR] Target lost in setStandMorphPosition")
                return 
            end
            
            if not Character or not HRP then
                print("[SBR] Character/HRP lost in setStandMorphPosition")
                return
            end
            
            -- Если нет стенда - просто следуем за игроком
            if LocalPlayer.PlayerStats.Stand.Value == "None" then
                HRP.CFrame = Target.HumanoidRootPart.CFrame - Vector3.new(0, 5, 0)
                print("[SBR] Following without stand (teleport)")
                return
            end
            
            -- Если стенд не призван - призываем
            if not Character:FindFirstChild("SummonedStand") or not Character.SummonedStand.Value or not Character:FindFirstChild("StandMorph") then
                print("[SBR] Summoning stand...")
                RemoteFunction:InvokeServer("ToggleStand", "Toggle")
                task.wait(0.5)
                return
            end
            
            if not Character:FindFirstChild("StandMorph") or not Character.StandMorph.PrimaryPart then
                print("[SBR] No StandMorph or PrimaryPart")
                return
            end
            
            -- ✅ ТОЧНОЕ ПОЗИЦИОНИРОВАНИЕ
            Character.StandMorph.PrimaryPart.CFrame = Target.HumanoidRootPart.CFrame + Target.HumanoidRootPart.CFrame.lookVector * -1.1
            HRP.CFrame = Character.StandMorph.PrimaryPart.CFrame + Character.StandMorph.PrimaryPart.CFrame.lookVector - Vector3.new(0, playerDistance, 0)
            
            print("[SBR] Position updated with stand")
            
            -- Устанавливаем фокус камеры
            if not Character:FindFirstChild("FocusCam") then
                local FocusCam = Instance.new("ObjectValue", Character)
                FocusCam.Name = "FocusCam"
                FocusCam.Value = Character.StandMorph.PrimaryPart
            end
            
            if Character:FindFirstChild("FocusCam") and Character.FocusCam.Value ~= Character.StandMorph.PrimaryPart then
                Character.FocusCam.Value = Character.StandMorph.PrimaryPart
            end
        end)
    end
    
    print(string.format("[SBR] Starting follow loop for %.1f seconds", duration))
    
    -- ✅ ГЛАВНЫЙ ЦИКЛ СЛЕДОВАНИЯ
    local loopCount = 0
    while beingTargeted and (tick() - startTime < duration) do
        loopCount = loopCount + 1
        
        if loopCount % 30 == 0 then  -- Каждые ~30 итераций выводим статус
            print(string.format("[SBR] Follow loop: %.1f/%.1f sec", tick() - startTime, duration))
        end
        
        task.wait(0.1)  -- ✅ ВАЖНО! Немного ждём между итерациями
        
        -- Проверяем HP игрока
        local healthPercent = GetPlayerHealthPercent(player)
        
        if healthPercent < 20 then
            print(string.format("[SBR] %s has low HP (%.1f%%) - switching target!", player.Name, healthPercent))
            beingTargeted = false
            break
        end
        
        -- Проверяем что игрок жив и существует
        if not Target or not Target.Parent or not Target:FindFirstChild("HumanoidRootPart") then
            print(string.format("[SBR] %s died or left - switching target!", player.Name))
            beingTargeted = false
            break
        end
        
        -- ✅ ПРИМЕНЯЕМ ПОЗИЦИОНИРОВАНИЕ
        setStandMorphPosition()
    end
    
    print(string.format("[SBR] ✓ Finished following after %.1f seconds (%d loops)", tick() - startTime, loopCount))
    
    -- ✅ ОЧИСТКА
    if Character and Character:FindFirstChild("FocusCam") then
        Character.FocusCam:Destroy()
    end
    
    return true
end

-- ═══════════════════════════════════════
-- SERVICES & VARIABLES
-- ═══════════════════════════════════════

local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")

local Camera = workspace.CurrentCamera

local Character = LocalPlayer.Character
repeat task.wait() until Character:FindFirstChild("RemoteEvent") and Character:FindFirstChild("RemoteFunction")

local RemoteFunction = Character.RemoteFunction
local RemoteEvent = Character.RemoteEvent
local HRP = Character.PrimaryPart

local ESPObjects = {}

-- ═══════════════════════════════════════
-- NOCLIP CONTROL FOR SBR (использует существующую функцию)
-- ═══════════════════════════════════════

local NoClipConnection = nil
local NoClipEnabled = false

local function EnableNoClip()
    if NoClipEnabled then return end
    
    NoClipEnabled = true
    print("[SBR] ✓ NoClip ENABLED")
    
    NoClipConnection = RunService.Stepped:Connect(function()
        if not NoClipEnabled then return end
        
        pcall(function()
            if LocalPlayer.Character then
                for _, child in pairs(LocalPlayer.Character:GetDescendants()) do
                    if child:IsA("BasePart") and child.CanCollide == true then
                        child.CanCollide = false
                    end
                end
            end
        end)
    end)
end

local function DisableNoClip()
    if not NoClipEnabled then return end
    
    NoClipEnabled = false
    print("[SBR] ✓ NoClip DISABLED")
    
    if NoClipConnection then
        NoClipConnection:Disconnect()
        NoClipConnection = nil
    end
    
    local Character = LocalPlayer.Character
    if Character then
        for _, child in pairs(Character:GetDescendants()) do
            if child:IsA("BasePart") and child.Name ~= "HumanoidRootPart" then
                child.CanCollide = true
            end
        end
    end
end

-- ═══════════════════════════════════════
-- SBR HELPER FUNCTIONS
-- ═══════════════════════════════════════
local function CheckStartBarrier()
    local barrier = workspace:FindFirstChild("Barrier")
    if not barrier then return false end
    
    local startBarrier = barrier:FindFirstChild("StartBarrier")
    return startBarrier ~= nil
end

local function GetPlayerCount()
    return #Players:GetPlayers()
end

local function CreateSafetyPlatform(position)
    local platform = Instance.new("Part")
    platform.Name = "SBRPlatform"
    platform.Parent = workspace
    platform.Anchored = true
    platform.Size = Vector3.new(50, 1, 50)
    platform.Position = position
    platform.Transparency = 1
    platform.CanCollide = true
    return platform
end

local function FindBeachPart()
    local beachPath = workspace:FindFirstChild("Map")
    if not beachPath then return nil end
    
    beachPath = beachPath:FindFirstChild("Beach")
    if not beachPath then return nil end
    
    beachPath = beachPath:FindFirstChild("Beach")
    if not beachPath then return nil end
    
    beachPath = beachPath:FindFirstChild("Base")
    if not beachPath then return nil end
    
    beachPath = beachPath:FindFirstChild("Terrain")
    if not beachPath then return nil end
    
    for _, part in pairs(beachPath:GetChildren()) do
        if part.Name == "Part" and part:IsA("BasePart") then
            local size = part.Size
            if math.abs(size.X - 800) < 1 and math.abs(size.Y - 0.25) < 0.1 and math.abs(size.Z - 30) < 1 then
                return part
            end
        end
    end
    
    return nil
end

local function CheckBarriers()
    local barriers = workspace:FindFirstChild("Barriers")
    if not barriers then return nil end
    
    local barrierList = {}
    for _, barrier in pairs(barriers:GetChildren()) do
        table.insert(barrierList, barrier.Name)
    end
    
    return barrierList
end

local function FindNYCBridgePart()
    local success, result = pcall(function()
        local nycBridge = workspace.Map["NYC Bridge"].NYCBridge.Main:GetChildren()[55]:GetChildren()[14]
        
        if nycBridge and nycBridge:IsA("BasePart") then
            local size = nycBridge.Size
            print(string.format("[SBR] Found NYC Bridge Part! Size: %.1f, %.1f, %.1f", size.X, size.Y, size.Z))
            return nycBridge
        end
    end)
    
    if success then
        return result
    else
        warn("[SBR] NYC Bridge Part not found!")
        return nil
    end
end


-- ═══════════════════════════════════════
-- MAIN SBR AUTOFARM FUNCTION (ПОЛНАЯ ЗАМЕНА)
-- ═══════════════════════════════════════

-- ═══════════════════════════════════════
-- MAIN SBR AUTOFARM FUNCTION (ПОЛНАЯ ВЕРСИЯ)
-- ═══════════════════════════════════════

-- ═══════════════════════════════════════
-- MAIN SBR AUTOFARM FUNCTION (ПОЛНАЯ ВЕРСИЯ С ЗАЩИТОЙ ОТ ПАДЕНИЯ)
-- ═══════════════════════════════════════

-- ═══════════════════════════════════════
-- MAIN SBR AUTOFARM FUNCTION (ПОЛНАЯ ВЕРСИЯ С ЗАЩИТОЙ ОТ ПАДЕНИЯ)
-- ═══════════════════════════════════════

local function AutoSBRFarm()
    local beachPlatform = nil
    local waitPlatform = nil
    
    -- ✅ CLEANUP ФУНКЦИЯ
    local function cleanup()
        pcall(function()
            if beachPlatform and beachPlatform.Parent then
                beachPlatform:Destroy()
                print("[SBR] Beach platform destroyed")
            end
        end)
        
        pcall(function()
            if waitPlatform and waitPlatform.Parent then
                waitPlatform:Destroy()
                print("[SBR] Wait platform destroyed")
            end
        end)
        
        -- Удаляем все временные платформы
        pcall(function()
            for _, platform in pairs(workspace:GetChildren()) do
                if platform.Name == "SBRStepPlatform" then
                    platform:Destroy()
                end
            end
        end)
        
        -- ✅ СНИМАЕМ ЯКОРЬ ЕСЛИ ОСТАЛСЯ
        pcall(function()
            local Character = LocalPlayer.Character
            local HRP = Character and Character:FindFirstChild("HumanoidRootPart")
            if HRP and HRP.Anchored then
                HRP.Anchored = false
                print("[SBR] HRP Unanchored in cleanup")
            end
        end)
    end
    
    -- ✅ ПРОВЕРКА PlaceId
    local currentPlaceId = game.PlaceId
    if currentPlaceId ~= 4643697430 then
        warn(string.format("[SBR] Wrong PlaceId: %d", currentPlaceId))
        return
    end
    
    print("[SBR] ═══════════════════════════════")
    print("[SBR] Starting SBR Autofarm...")
    print("[SBR] ✓ Confirmed in Metal Ball Run")
    
    -- ✅ ЗАЩИТА ОТ ОШИБОК
    local success, err = pcall(function()
        
        -- ШАГ 1: Слезаем с лошади
        print("[SBR] Dismounting horse...")
        for i = 1, 5 do
            pcall(function()
                game:GetService("VirtualInputManager"):SendKeyEvent(true, Enum.KeyCode.LeftControl, false, game)
                task.wait(0.05)
                game:GetService("VirtualInputManager"):SendKeyEvent(false, Enum.KeyCode.LeftControl, false, game)
            end)
            task.wait(0.15)
        end
        task.wait(0.5)
        
        -- ШАГ 2: Телепорт на пляж
        print("[SBR] Finding Beach part...")
        local beachPart = FindBeachPart()
        
        if not beachPart then
            beachPart = {Position = Vector3.new(0, 100, 0)}
        end
        
        local safePosition = beachPart.Position + Vector3.new(0, 500, 0)
        beachPlatform = CreateSafetyPlatform(safePosition)
        
        local Character = LocalPlayer.Character
        local HRP = Character and Character:FindFirstChild("HumanoidRootPart")
        
        if HRP then
            HRP.CFrame = CFrame.new(safePosition + Vector3.new(0, 10, 0))
            print("[SBR] ✓ Teleported to beach platform!")
        end
        
        task.wait(1)
        
        -- ШАГ 3: Проверка игроков
        local hasStartBarrier = CheckStartBarrier()
        local barriers = CheckBarriers()
        local raceNotStarted = false
        
        if hasStartBarrier and barriers and #barriers == 4 then
            local has1 = table.find(barriers, "1") ~= nil
            local has2 = table.find(barriers, "2") ~= nil
            local has3 = table.find(barriers, "3") ~= nil
            local has4 = table.find(barriers, "4") ~= nil
            
            if has1 and has2 and has3 and has4 then
                raceNotStarted = true
            end
        end
        
        if raceNotStarted then
            local playerCount = GetPlayerCount()
            print(string.format("[SBR] Players: %d", playerCount))
            
            if playerCount < 10 then
                print("[SBR] < 10 players - waiting 20 sec...")
                task.wait(20)
                
                playerCount = GetPlayerCount()
                
                if playerCount < 10 then
                    print("[SBR] Still < 10 - returning to YBA!")
                    cleanup()
                    SaveConfig()
                    game:GetService("TeleportService"):Teleport(2809202155, LocalPlayer)
                    return
                end
            end
        end
        
        -- ШАГ 4: Ждём барьер 4
        print("[SBR] ═══════════════════════════════")
        print("[SBR] Waiting for barrier 4...")
        
        local waitingForBarrier4 = true
        local maxWaitTime = 1200
        local waitedTime = 0
        local lastAFKMove = tick()
        
        while waitingForBarrier4 and waitedTime < maxWaitTime do
            task.wait(5)
            waitedTime = waitedTime + 5
            
            -- Анти-AFK
            if (tick() - lastAFKMove) >= 15 then
                pcall(function()
                    game:GetService("VirtualInputManager"):SendKeyEvent(true, Enum.KeyCode.W, false, game)
                    task.wait(0.3)
                    game:GetService("VirtualInputManager"):SendKeyEvent(false, Enum.KeyCode.W, false, game)
                    task.wait(0.1)
                    game:GetService("VirtualInputManager"):SendKeyEvent(true, Enum.KeyCode.S, false, game)
                    task.wait(0.3)
                    game:GetService("VirtualInputManager"):SendKeyEvent(false, Enum.KeyCode.S, false, game)
                end)
                lastAFKMove = tick()
            end
            
            barriers = CheckBarriers()
            
            if barriers then
                if #barriers == 1 and barriers[1] == "4" then
                    print("[SBR] ✓ Only barrier 4 remaining!")
                    waitingForBarrier4 = false
                    break
                end
            end
        end
        
        if waitedTime >= maxWaitTime then
            warn("[SBR] Timeout - returning to YBA...")
            cleanup()
            SaveConfig()
            game:GetService("TeleportService"):Teleport(2809202155, LocalPlayer)
            return
        end
        
        -- ═══════════════════════════════════════
        -- ШАГ 5: ТЕЛЕПОРТ НА БЕЗОПАСНУЮ ПОЗИЦИЮ (NYC BRIDGE)
        -- ═══════════════════════════════════════
        
        print("[SBR] ═══════════════════════════════")
        print("[SBR] Barrier 4 detected - finding NYC Bridge Part!")
        
        if beachPlatform then 
            beachPlatform:Destroy() 
            beachPlatform = nil
        end
        
        -- ✅ ИЩЕМ УНИКАЛЬНЫЙ ПАРТ НА МОСТУ
        local bridgePart = FindNYCBridgePart()
        
        if not bridgePart then
            warn("[SBR] NYC Bridge Part not found - returning to YBA!")
            cleanup()
            SaveConfig()
            game:GetService("TeleportService"):Teleport(2809202155, LocalPlayer)
            return
        end
        
        local safeWaitPosition = bridgePart.Position
        
        print("[SBR] ✓ NYC Bridge Part found!")
        print(string.format("[SBR] - Target: %.2f, %.2f, %.2f", 
            safeWaitPosition.X,
            safeWaitPosition.Y,
            safeWaitPosition.Z
        ))
        print(string.format("[SBR] - Size: %.1f, %.1f, %.1f",
            bridgePart.Size.X,
            bridgePart.Size.Y,
            bridgePart.Size.Z
        ))
        
        -- ✅ ВКЛЮЧАЕМ NOCLIP ДЛЯ ТЕЛЕПОРТА
        print("[SBR] Enabling NoClip for safe teleport...")
        EnableNoClip()
        
        -- ✅ ПЛАВНЫЙ ТЕЛЕПОРТ ВНУТРЬ ПАРТА НА МОСТУ
        print("[SBR] Moving to NYC Bridge Part (smooth)...")
        smoothTeleport(safeWaitPosition)
        print("[SBR] ✓ Inside NYC Bridge Part!")
        
        task.wait(1)
        
        -- ✅ СОЗДАЁМ ПЛАТФОРМУ ВНУТРИ ПАРТА
        local platformCreated = pcall(function()
            waitPlatform = Instance.new("Part")
            waitPlatform.Name = "SBRWaitPlatform"
            waitPlatform.Parent = workspace
            waitPlatform.Anchored = true
            waitPlatform.Size = SBR_CONFIG.PlatformSize
            waitPlatform.Position = safeWaitPosition + Vector3.new(0, SBR_CONFIG.PlatformOffset, 0)
            waitPlatform.Transparency = 1
            waitPlatform.CanCollide = true
        end)
        
        if not platformCreated or not waitPlatform then
            warn("[SBR] Failed to create wait platform!")
            DisableNoClip()
            cleanup()
            SaveConfig()
            game:GetService("TeleportService"):Teleport(2809202155, LocalPlayer)
            return
        end
        
        print("[SBR] ✓ Wait platform created inside bridge part")
        
        task.wait(0.5)
        
        -- ═══════════════════════════════════════
        -- ✅ ОПУСКАЕМСЯ ВНИЗ (5 ТЕЛЕПОРТОВ ПОД КАРТУ) - ИДЕАЛЬНАЯ ВЕРСИЯ
        -- ═══════════════════════════════════════
        
        print("[SBR] ═══════════════════════════════")
        print("[SBR] Descending below the map (5 steps)...")
        
        Character = LocalPlayer.Character
        HRP = Character and Character:FindFirstChild("HumanoidRootPart")
        
        if HRP then
            -- ✅ ЯКОРЬ - персонаж не провалится даже без платформы!
            HRP.Anchored = true
            print("[SBR] ✓ HRP Anchored")
            
            for i = 1, 5 do
                local success = pcall(function()
                    Character = LocalPlayer.Character
                    HRP = Character and Character:FindFirstChild("HumanoidRootPart")
                    
                    if not HRP then
                        warn(string.format("[SBR] Lost HRP at descent step %d", i))
                        return
                    end
                    
                    local currentPos = HRP.Position
                    local newPos = currentPos - Vector3.new(0, 15, 0)
                    
                    print(string.format("[SBR] Step %d/5:", i))
                    print(string.format("  Current Y: %.1f", currentPos.Y))
                    print(string.format("  Target Y: %.1f", newPos.Y))
                    
                    -- ✅ СОЗДАЁМ НОВУЮ ПЛАТФОРМУ В ЦЕЛЕВОЙ ПОЗИЦИИ
                    local newPlatform = Instance.new("Part")
                    newPlatform.Name = "SBRWaitPlatform_New"
                    newPlatform.Parent = workspace
                    newPlatform.Anchored = true
                    newPlatform.Size = SBR_CONFIG.PlatformSize
                    newPlatform.Position = newPos + Vector3.new(0, SBR_CONFIG.PlatformOffset, 0)
                    newPlatform.Transparency = 1
                    newPlatform.CanCollide = true
                    
                    print(string.format("  ✓ Created new platform at Y: %.1f", newPlatform.Position.Y))
                    
                    task.wait(0.2)
                    
                    -- ✅ ТЕЛЕПОРТИРУЕМ ПЕРСОНАЖА
                    HRP.CFrame = CFrame.new(newPos)
                    print(string.format("  ✓ Teleported to Y: %.1f", newPos.Y))
                    
                    task.wait(0.2)
                    
                    -- ✅ УДАЛЯЕМ СТАРУЮ ПЛАТФОРМУ
                    if waitPlatform and waitPlatform.Parent then
                        waitPlatform:Destroy()
                        print("  ✓ Destroyed old platform")
                    end
                    
                    -- ✅ НОВАЯ ПЛАТФОРМА СТАНОВИТСЯ ТЕКУЩЕЙ
                    waitPlatform = newPlatform
                    
                    print(string.format("  ✓ Step %d/5 completed!", i))
                end)
                
                if not success then
                    warn(string.format("[SBR] Step %d failed", i))
                end
                
                task.wait(0.3)
            end
            
            -- ✅ ФИНАЛЬНАЯ ПРОВЕРКА ПЛАТФОРМЫ
            task.wait(0.5)
            
            local finalY = HRP.Position.Y
            print(string.format("[SBR] ✓ Below the map! Final Y: %.1f", finalY))
            
            -- ✅ ПРОВЕРЯЕМ ЧТО ПЛАТФОРМА СУЩЕСТВУЕТ И КОЛЛИЗИЯ РАБОТАЕТ
            if waitPlatform and waitPlatform.Parent then
                print("[SBR] ✓ Wait platform verified:")
                print(string.format("  - Platform Y: %.1f", waitPlatform.Position.Y))
                print(string.format("  - Anchored: %s", tostring(waitPlatform.Anchored)))
                print(string.format("  - CanCollide: %s", tostring(waitPlatform.CanCollide)))
                
                -- ✅ ПРИНУДИТЕЛЬНО ФИКСИРУЕМ СВОЙСТВА
                waitPlatform.Anchored = true
                waitPlatform.CanCollide = true
                task.wait(0.1)
            else
                warn("[SBR] WARNING: Wait platform doesn't exist!")
            end
            
            -- ✅ СНИМАЕМ ЯКОРЬ - теперь персонаж стоит на платформе
            HRP.Anchored = false
            print("[SBR] ✓ HRP Unanchored")
            
            -- ✅ ПРОВЕРЯЕМ ЧТО НЕ ПРОВАЛИВАЕМСЯ
            task.wait(0.5)
            local checkY = HRP.Position.Y
            if math.abs(checkY - finalY) > 5 then
                warn(string.format("[SBR] WARNING: Character fell! Y changed from %.1f to %.1f", finalY, checkY))
                -- ✅ АВАРИЙНЫЙ РЕЖИМ - якорим снова!
                HRP.Anchored = true
                HRP.CFrame = CFrame.new(HRP.Position.X, finalY, HRP.Position.Z)
                task.wait(0.3)
                HRP.Anchored = false
            else
                print(string.format("[SBR] ✓ Character stable at Y: %.1f", checkY))
            end
            
        else
            warn("[SBR] No HRP for descent!")
        end
        
        print("[SBR] ═══════════════════════════════")
        
        task.wait(1)
        
        -- ✅ ОТКЛЮЧАЕМ NOCLIP
        print("[SBR] Disabling NoClip...")
        DisableNoClip()
        
        print(string.format("[SBR] ✓ Final position reached!"))
        if waitPlatform and waitPlatform.Parent then
            print(string.format("[SBR] - Platform position: %.2f, %.2f, %.2f", 
                waitPlatform.Position.X, 
                waitPlatform.Position.Y, 
                waitPlatform.Position.Z
            ))
        end
        
        task.wait(1)
        
        -- ═══════════════════════════════════════
        -- ШАГ 6: ЖДЁМ БАРЬЕР 4
        -- ═══════════════════════════════════════
        
        print("[SBR] Waiting for barrier 4 to disappear...")
        print("[SBR] (No anti-AFK at this position)")
        
        local waitStartTime = tick()
        local maxBarrierWaitTime = 1200
        
        while true do
            task.wait(5)
            
            -- ✅ ПРОВЕРЯЕМ ЧТО ПЕРСОНАЖ ЖИВ
            if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                warn("[SBR] Character lost - returning to YBA...")
                cleanup()
                SaveConfig()
                game:GetService("TeleportService"):Teleport(2809202155, LocalPlayer)
                return
            end
            
            if (tick() - waitStartTime) > maxBarrierWaitTime then
                warn("[SBR] Barrier timeout - returning to YBA...")
                cleanup()
                SaveConfig()
                game:GetService("TeleportService"):Teleport(2809202155, LocalPlayer)
                return
            end
            
            barriers = CheckBarriers()
            
            if not barriers or not table.find(barriers, "4") then
                print("[SBR] ✓ Barrier 4 disappeared!")
                break
            end
            
            if math.floor((tick() - waitStartTime)) % 30 == 0 then
                print(string.format("[SBR] Waiting... (%.0f sec)", tick() - waitStartTime))
            end
        end
        
        print("[SBR] ✓ Proceeding to finish!")
        
        if waitPlatform then 
            waitPlatform:Destroy()
            waitPlatform = nil
        end
        -- ═══════════════════════════════════════
        -- ШАГ 7: ЗАДЕРЖКА ПЕРЕД ФИНИШЕМ
        -- ═══════════════════════════════════════
        
        local waitTime = SBR_CONFIG.WaitBeforeFinish or 10
        print("[SBR] ═══════════════════════════════")
        print(string.format("[SBR] Waiting %d seconds before finish teleport...", waitTime))
        
        for i = 1, waitTime do
            task.wait(1)
            
            -- Проверяем что персонаж жив
            if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                warn("[SBR] Character lost during wait!")
                cleanup()
                SaveConfig()
                game:GetService("TeleportService"):Teleport(2809202155, LocalPlayer)
                return
            end
            
            if i % 5 == 0 or i == waitTime then
                print(string.format("[SBR] Waiting... %d/%d sec", i, waitTime))
            end
        end
        
        print("[SBR] ✓ Wait completed!")
        print("[SBR] ═══════════════════════════════")
        
        -- ═══════════════════════════════════════
        -- ШАГ 8: ФИНИШ (ПРЯМО ВНУТРЬ ХИТБОКСА!)
        -- ═══════════════════════════════════════
        
        print("[SBR] Teleporting to Finish...")
        
        local finishPart = nil
        local targetPosition = nil
        
        -- ✅ Сначала пробуем из конфига
        if SBR_CONFIG.FinishPosition then
            targetPosition = SBR_CONFIG.FinishPosition
            print("[SBR] Using predefined finish position")
        else
            -- ✅ Ищем workspace.Finish
            local finishObject = workspace:FindFirstChild("Finish")
            
            if finishObject then
                print("[SBR] ✓ Found workspace.Finish")
                
                -- ✅ Проверяем тип объекта
                if finishObject:IsA("BasePart") then
                    finishPart = finishObject
                    print("[SBR] - Type: BasePart")
                    
                elseif finishObject:IsA("Model") then
                    print("[SBR] - Type: Model")
                    
                    if finishObject.PrimaryPart then
                        finishPart = finishObject.PrimaryPart
                        print("[SBR] - Using PrimaryPart")
                    else
                        -- Ищем любой BasePart внутри
                        for _, child in pairs(finishObject:GetDescendants()) do
                            if child:IsA("BasePart") then
                                finishPart = child
                                print("[SBR] - Using first BasePart found")
                                break
                            end
                        end
                    end
                end
                
                if finishPart then
                    targetPosition = finishPart.Position
                    print(string.format("[SBR] ✓ Finish position: %.2f, %.2f, %.2f", 
                        targetPosition.X, targetPosition.Y, targetPosition.Z))
                    print(string.format("[SBR] - Size: %.1f, %.1f, %.1f",
                        finishPart.Size.X, finishPart.Size.Y, finishPart.Size.Z))
                end
            end
            
            -- ✅ Если не нашли - ищем в Map
            if not targetPosition then
                warn("[SBR] workspace.Finish not found! Searching in Map...")
                
                local map = workspace:FindFirstChild("Map")
                if map then
                    finishObject = map:FindFirstChild("Finish", true)
                    
                    if finishObject then
                        if finishObject:IsA("BasePart") then
                            finishPart = finishObject
                        elseif finishObject:IsA("Model") and finishObject.PrimaryPart then
                            finishPart = finishObject.PrimaryPart
                        end
                        
                        if finishPart then
                            targetPosition = finishPart.Position
                            print("[SBR] ✓ Found Finish in Map!")
                        end
                    end
                end
            end
        end
        
        if not targetPosition then
            warn("[SBR] Finish not found anywhere!")
            cleanup()
            SaveConfig()
            game:GetService("TeleportService"):Teleport(2809202155, LocalPlayer)
            return
        end
        
        -- ✅ ВКЛЮЧАЕМ NOCLIP ДЛЯ ТЕЛЕПОРТА ВНУТРЬ ХИТБОКСА!
        print("[SBR] Enabling NoClip for finish teleport...")
        EnableNoClip()
        
        task.wait(0.5)
        
        -- ✅ ЯКОРЬ УЖЕ ВКЛЮЧЕН - телепортируемся ВНУТРЬ!
        print("[SBR] Moving INSIDE Finish hitbox (smooth) with Anchor + NoClip...")
        smoothTeleport(targetPosition)
        print("[SBR] ✓ Inside Finish hitbox!")
        
        task.wait(1)
        
        -- ✅ ОТКЛЮЧАЕМ NOCLIP
        print("[SBR] Disabling NoClip...")
        DisableNoClip()
        
        task.wait(0.5)
        
        -- ✅ СНИМАЕМ ЯКОРЬ - теперь игра зарегистрирует финиш!
        Character = LocalPlayer.Character
        HRP = Character and Character:FindFirstChild("HumanoidRootPart")
        if HRP then
            HRP.Anchored = false
            print("[SBR] ✓ HRP Unanchored - finish should trigger!")
        end
        
        task.wait(5)
        
        print("[SBR] ═══════════════════════════════")
        print("[SBR] Race completed!")
        print("[SBR] ═══════════════════════════════")
        
    end)
    
    -- ✅ ВСЕГДА ОЧИЩАЕМ
    cleanup()
    
    if not success then
        warn("[SBR] Error:", err)
    end
    
    SaveConfig()
    game:GetService("TeleportService"):Teleport(2809202155, LocalPlayer)
end
    
-- ✅ ТЕПЕРЬ Config ГОТОВ К ИСПОЛЬЗОВАНИЮ!
local function SelectTopmostAndLeftmostServer()
    print("[Lithium] Finding topmost and leftmost Sample button...")
    
    local serverGui = LocalPlayer.PlayerGui:FindFirstChild("Metal Ball Run Servers")
    if not serverGui then
        warn("[Lithium] Metal Ball Run Servers GUI not found!")
        return false
    end
    
    local frame = serverGui:FindFirstChild("Frame")
    if not frame then
        warn("[Lithium] Frame not found!")
        return false
    end
    
    local scrollingFrame = frame:FindFirstChild("ScrollingFrame")
    if not scrollingFrame then
        warn("[Lithium] ScrollingFrame not found!")
        return false
    end
    
    print("[Lithium] ✓ Found server list")
    
    -- ✅ Ждем чтобы кнопки точно загрузились
    task.wait(1)
    
    local bestButton = nil
    local lowestY = math.huge
    local lowestX = math.huge
    local sampleCount = 0
    
    -- ✅ Ищем все кнопки "Sample"
    for _, child in pairs(scrollingFrame:GetChildren()) do
        if child.Name == "Sample" then
            sampleCount = sampleCount + 1
            
            -- ✅ Получаем позицию
            local xScale = child.Position.X.Scale
            local yScale = child.Position.Y.Scale
            
            print(string.format("[Lithium] Sample #%d - Position: {%.3f, 0}, {%.3f, 0}", 
                sampleCount, xScale, yScale))
            
            -- ✅ Выбираем самый верхний (минимальный Y)
            if yScale < lowestY then
                lowestY = yScale
                lowestX = xScale
                bestButton = child
                print(string.format("  └─ NEW BEST! (Y: %.3f, X: %.3f)", yScale, xScale))
            -- ✅ Если Y одинаковый - выбираем самый левый (минимальный X)
            elseif yScale == lowestY and xScale < lowestX then
                lowestX = xScale
                bestButton = child
                print(string.format("  └─ NEW BEST! (same Y, but X: %.3f)", xScale))
            end
        end
    end
    
    print(string.format("[Lithium] Total Sample buttons found: %d", sampleCount))
    
    if bestButton then
        print(string.format("[Lithium] ✓ Selected best Sample (Y: %.3f, X: %.3f)", lowestY, lowestX))
        
        -- ✅ Если это Frame, ищем кнопку внутри
        local buttonToClick = bestButton
        if bestButton:IsA("Frame") then
            for _, child in pairs(bestButton:GetChildren()) do
                if child:IsA("TextButton") or child:IsA("ImageButton") then
                    buttonToClick = child
                    print("[Lithium] ✓ Found button inside Frame")
                    break
                end
            end
        end
        
        -- ✅ Нажимаем кнопку
        for i = 1, 10 do
            pcall(function()
                firesignal(buttonToClick.MouseButton1Down)
                firesignal(buttonToClick.MouseButton1Up)
                firesignal(buttonToClick.MouseButton1Click)
                firesignal(buttonToClick.Activated)
            end)
            task.wait(0.1)
        end
        
        print("[Lithium] ✓ Clicked best Sample!")
        return true
    else
        warn("[Lithium] No Sample buttons found!")
        return false
    end
end
-- ✅ ПРОВЕРЯЕМ PlaceId - это Your Bizarre Adventure?
local currentPlaceId = game.PlaceId
print(string.format("[Lithium] Current PlaceId: %d", currentPlaceId))

-- ✅ Если мы в Metal Ball Run - пропускаем нажатие кнопок!
if currentPlaceId == 4643697430 then
    print("[Lithium] ═══════════════════════════════")
    print("[Lithium] In Metal Ball Run - skipping button clicks")
    print("[Lithium] Ready to farm SBR!")
    print("[Lithium] ═══════════════════════════════")
elseif currentPlaceId == 2809202155 then
    print("[Lithium] ═══════════════════════════════")
    print("[Lithium] Your Bizarre Adventure detected!")
    print("[Lithium] Waiting 10 seconds before clicking buttons...")
    task.wait(10)
    print("[Lithium] ✓ 10 seconds passed!")
    
    -- ✅ ПРОВЕРЯЕМ: Заходим в SBR или в главную игру?
    if Config.JoinSBR then
        print("[Lithium] JoinSBR = true - clicking SBR buttons!")
        
        local success, err = pcall(function()
            local loadingScreen = LocalPlayer.PlayerGui:WaitForChild("LoadingScreen", 30)
            
            if not loadingScreen then
                warn("[Lithium] LoadingScreen not found after 30 seconds!")
                return
            end
            
            print("[Lithium] ✓ LoadingScreen found")
            
            -- ШАГ 1: Нажимаем Main.Play
            print("[Lithium] Step 1: Clicking Main.Play...")
            local mainFrame = loadingScreen.Frames:FindFirstChild("Main")
            if mainFrame and mainFrame:FindFirstChild("Play") then
                local mainPlayButton = mainFrame.Play
                print("[Lithium] ✓ Found Main.Play button")
                
                for i = 1, 5 do
                    pcall(function()
                        firesignal(mainPlayButton.MouseButton1Down)
                        firesignal(mainPlayButton.MouseButton1Up)
                        firesignal(mainPlayButton.MouseButton1Click)
                        firesignal(mainPlayButton.Activated)
                    end)
                    task.wait(0.1)
                end
                
                print("[Lithium] ✓ Clicked Main.Play")
            else
                warn("[Lithium] Main.Play not found!")
            end
            
            -- ШАГ 2: Ждем 1 секунду
            print("[Lithium] Waiting 1 second...")
            task.wait(1)
            
            -- ШАГ 3: Нажимаем GameModes.ScrollingFrame.SBR
            print("[Lithium] Step 2: Clicking SBR button...")
            local gamemodesFrame = loadingScreen.Frames:FindFirstChild("Gamemodes")
            if gamemodesFrame then
                local gameModesFrame = gamemodesFrame:FindFirstChild("GameModes")
                if gameModesFrame then
                    local scrollingFrame = gameModesFrame:FindFirstChild("ScrollingFrame")
                    if scrollingFrame then
                        local sbrButton = scrollingFrame:FindFirstChild("SBR")
                        if sbrButton then
                            print("[Lithium] ✓ Found SBR button")
                            
                            for i = 1, 5 do
                                pcall(function()
                                    firesignal(sbrButton.MouseButton1Down)
                                    firesignal(sbrButton.MouseButton1Up)
                                    firesignal(sbrButton.MouseButton1Click)
                                    firesignal(sbrButton.Activated)
                                end)
                                task.wait(0.1)
                            end
                            
                            print("[Lithium] ✓ Clicked SBR button")
                        else
                            warn("[Lithium] SBR button not found!")
                        end
                    end
                end
            end
            
            -- ШАГ 4: Ждем 1 секунду
            print("[Lithium] Waiting 1 second...")
            task.wait(1)
            
            -- ШАГ 5: Нажимаем Normal.Play или Ranked.Play
            print(string.format("[Lithium] Step 3: Clicking %s.Play...", Config.SBRMode))
            local sbrFrame = loadingScreen.Frames:FindFirstChild("SteelBallRun")
            if sbrFrame then
                local modeFrame = sbrFrame:FindFirstChild(Config.SBRMode)
                if modeFrame then
                    local modePlayButton = modeFrame:FindFirstChild("Play")
                    if modePlayButton then
                        print(string.format("[Lithium] ✓ Found %s.Play button", Config.SBRMode))
                        
                        for i = 1, 5 do
                            pcall(function()
                                firesignal(modePlayButton.MouseButton1Down)
                                firesignal(modePlayButton.MouseButton1Up)
                                firesignal(modePlayButton.MouseButton1Click)
                                firesignal(modePlayButton.Activated)
                            end)
                            task.wait(0.1)
                        end
                        
                        print(string.format("[Lithium] ✓ Clicked %s.Play", Config.SBRMode))
                    else
                        warn(string.format("[Lithium] %s.Play not found!", Config.SBRMode))
                    end
                else
                    warn(string.format("[Lithium] %s frame not found!", Config.SBRMode))
                end
            else
                warn("[Lithium] SteelBallRun frame not found!")
            end
            
            -- ШАГ 6: Ждем 7 секунд
            print("[Lithium] Waiting 7 seconds for server list...")
            task.wait(7)
            
            -- ШАГ 7: Выбираем самый верхний и левый Sample
            print("[Lithium] Step 4: Selecting topmost and leftmost Sample...")
            SelectTopmostAndLeftmostServer()
            
            print("[Lithium] ✓ SBR button sequence complete!")
        end)
        
        if success then
            print("[Lithium] ✓ SBR button click successful!")
        else
            warn("[Lithium] ✗ SBR button click failed:", err)
            warn("[Lithium] Continuing initialization anyway...")
        end
    else
        print("[Lithium] JoinSBR = false - clicking normal game buttons!")
        
        local success, err = pcall(function()
            print("[Lithium] Clicking LoadingScreen button...")
            
            local loadingScreen = LocalPlayer.PlayerGui:WaitForChild("LoadingScreen", 30)
            
            if not loadingScreen then
                warn("[Lithium] LoadingScreen not found after 30 seconds!")
                return
            end
            
            print("[Lithium] ✓ LoadingScreen found")
            
            -- ✅ НАЖИМАЕМ КНОПКУ: Gamemodes.MainGame.Play
            if loadingScreen:FindFirstChild("Frames") then
                local frames = loadingScreen.Frames
                
                if frames:FindFirstChild("Gamemodes") then
                    local gamemodesFrame = frames.Gamemodes
                    
                    if gamemodesFrame:FindFirstChild("MainGame") then
                        local mainGameFrame = gamemodesFrame.MainGame
                        
                        if mainGameFrame:FindFirstChild("Play") then
                            local playButton = mainGameFrame.Play
                            print("[Lithium] ✓ Found Gamemodes.MainGame.Play button")
                            
                            for i = 1, 5 do
                                pcall(function()
                                    firesignal(playButton.MouseButton1Down)
                                    firesignal(playButton.MouseButton1Up)
                                    firesignal(playButton.MouseButton1Click)
                                    firesignal(playButton.Activated)
                                end)
                                task.wait(0.1)
                            end
                            
                            print("[Lithium] ✓ Clicked Gamemodes.MainGame.Play")
                        else
                            warn("[Lithium] Gamemodes.MainGame.Play not found!")
                        end
                    else
                        warn("[Lithium] MainGame not found!")
                    end
                else
                    warn("[Lithium] Gamemodes not found!")
                end
            else
                warn("[Lithium] Frames not found!")
            end
            
            print("[Lithium] ✓ LoadingScreen button handled!")
        end)
        
        if success then
            print("[Lithium] ✓ Button click successful!")
        else
            warn("[Lithium] ✗ Button click failed:", err)
            warn("[Lithium] Continuing initialization anyway...")
        end
    end
    
    print("[Lithium] ═══════════════════════════════")
    
    print("[Lithium] Waiting 3 seconds for game to stabilize...")
    task.wait(3)
    print("[Lithium] ✓ Ready to continue!")
else
    print("[Lithium] Not in Your Bizarre Adventure - skipping button clicks")
end

-- ═══════════════════════════════════════
-- КРИТИЧНАЯ ИНИЦИАЛИЗАЦИЯ
-- ═══════════════════════════════════════

-- ✅ СУПЕР-НАДЁЖНАЯ ВЕРСИЯ с дополнительными проверками

game:GetService("CoreGui").DescendantAdded:Connect(function(child)
    if child.Name == "ErrorPrompt" then
        task.spawn(function()
            print("[Lithium] ⚠️ Error prompt detected - initiating emergency teleport!")
            
            -- Сохраняем конфиг БЕЗ задержек
            pcall(SaveConfig)
            
            -- МГНОВЕННЫЙ телепорт (без ожидания текста ошибки)
            for attempt = 1, 3 do
                local success = pcall(function()
                    game:GetService("TeleportService"):Teleport(2809202155, LocalPlayer)
                end)
                
                if success then
                    print(string.format("[Lithium] Teleport initiated (attempt %d)", attempt))
                    break
                else
                    warn(string.format("[Lithium] Teleport attempt %d failed, retrying...", attempt))
                    task.wait(1)
                end
            end
        end)
    end
end)

repeat task.wait() until game:IsLoaded() and game:GetService("Players").LocalPlayer and game:GetService("Players").LocalPlayer.Character



-- ═══════════════════════════════════════
-- УСТАНОВКА HOOKS
-- ═══════════════════════════════════════

print("[Lithium] Setting up hooks...")

local itemHook
itemHook = hookfunction(getrawmetatable(game.Players.LocalPlayer.Character.HumanoidRootPart.Position).__index, function(p, i)
    local caller = getcallingscript()
    if caller and caller.Name == "ItemSpawn" and i:lower() == "magnitude" then
        return 0
    end
    return itemHook(p, i)
end)

local Hook
Hook = hookmetamethod(game, '__namecall', newcclosure(function(self, ...)
    local args = {...}
    local namecallmethod = getnamecallmethod()
    if namecallmethod == "InvokeServer" then
        if args[1] == "idklolbrah2de" then
            return "  ___XP DE KEY"
        end
    end
    return Hook(self, ...)
end))

hookfunction(workspace.Raycast, function()
    return
end)

print("[Lithium] Hooks установлены")

-- ═══════════════════════════════════════
-- ANTI-COLLISION SYSTEM
-- ═══════════════════════════════════════

local function disableCollisions(char)
    char = char or LocalPlayer.Character
    if char then
        for _, child in pairs(char:GetDescendants()) do
            if child:IsA("BasePart") and child.CanCollide == true then
                child.CanCollide = false
            end
        end
    end
end

task.spawn(function()
    task.wait(1)
    disableCollisions()
end)

-- ═══════════════════════════════════════
-- CHARACTER RESPAWN HANDLER
-- ═══════════════════════════════════════

local function updateCharacter()
    Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    repeat task.wait() until Character:FindFirstChild("RemoteEvent") and Character:FindFirstChild("RemoteFunction")
    HRP = Character:WaitForChild("HumanoidRootPart")
    RemoteFunction = Character:WaitForChild("RemoteFunction")
    RemoteEvent = Character:WaitForChild("RemoteEvent")
    task.wait(1)
    disableCollisions(Character)
    print("[Lithium] Character updated after respawn")
end

LocalPlayer.CharacterAdded:Connect(function(newChar)
    task.wait(0.5)
    updateCharacter()
end)

-- ═══════════════════════════════════════
-- DEPTH OF FIELD FIX
-- ═══════════════════════════════════════

task.spawn(function()
    if game.Lighting:WaitForChild("DepthOfField", 10) then
        game.Lighting.DepthOfField:Destroy()
    end
end)



local MobList = {
    "Security Guard",
    "Leaky Eye Luca",
    "Bucciarati",
    "Fugo",
    "Pesci",
    "Ghiaccio",
    "Diavolo",
    "Vampire"
}

local ItemList = {
    "All Items",
    "Lucky Arrow",
    "Lucky Stone Mask",
    "Mysterious Arrow",
    "Rokakaka",
    "Diamond",
    "Steel Ball",
    "Dio's Diary",
    "Quinton's Glove",
    "Pure Rokakaka",
    "Ribcage Of The Saint's Corpse",
    "Ancient Scroll",
    "Clackers",
    "Caesar's Headband",
    "Zeppeli's Hat",
    "Requiem Arrow"
}
-- ✅ ДОБАВЬ ЭТО!
local ProtectedItems = {
    "Lucky Arrow",
    "Lucky Stone Mask",
    "Requiem Arrow"
}

local AllStandsList = {
    "The World",
    "Star Platinum",
    "Crazy Diamond",
    "King Crimson",
    "Gold Experience",
    "Silver Chariot",
    "Killer Queen",
    "Whitesnake",
    "The Hand",
    "Sticky Fingers",
    "Hierophant Green",
    "Magician's Red",
    "Hermit Purple",
    "Aerosmith",
    "Mr. President",
    "Beach Boy",
    "White Album",
    "Purple Haze",
    "Sex Pistols",
    "Cream"
}

local SkinsList = {
    "None",
    "Retro The World",
    "Shadow The World",
    "Manga King Crimson",
    "Volcanic Gold Experience",
    "Spooky Scary Skeleton",
    "Crystallized",
    "Jade Peace"
}

-- ═══════════════════════════════════════
-- HUD CHECK
-- ═══════════════════════════════════════

if not LocalPlayer.PlayerGui:FindFirstChild("HUD") then
    local HUD = game:GetService("ReplicatedStorage").Objects.HUD:Clone()
    HUD.Parent = LocalPlayer.PlayerGui
end

RemoteEvent:FireServer("PressedPlay")
task.wait(5.0)

if LocalPlayer.PlayerGui:FindFirstChild("LoadingScreen1") then
    LocalPlayer.PlayerGui:FindFirstChild("LoadingScreen1"):Destroy()
end

if LocalPlayer.PlayerGui:FindFirstChild("LoadingScreen") then
    LocalPlayer.PlayerGui:FindFirstChild("LoadingScreen"):Destroy()
end

local part = Instance.new("Part")
part.Parent = workspace
part.Anchored = true
part.Size = Vector3.new(25, 1, 25)
part.Position = Vector3.new(500, 2000, 500)

local dontTPOnDeath = true

-- ═══════════════════════════════════════
-- APPLE GLASS UI LIBRARY
-- ═══════════════════════════════════════

local Library = {}
Library.__index = Library

local Colors = {
    Background = Color3.fromRGB(0, 0, 0),
    BackgroundTransparency = 0.05,
    Secondary = Color3.fromRGB(15, 15, 20),
    SecondaryTransparency = 0.1,
    Tertiary = Color3.fromRGB(25, 25, 30),
    TertiaryTransparency = 0.15,
    Card = Color3.fromRGB(30, 30, 35),
    CardTransparency = 0.1,
    CardHover = Color3.fromRGB(40, 40, 45),
    CardHoverTransparency = 0.08,
    Border = Color3.fromRGB(255, 255, 255),
    BorderTransparency = 0.85,
    BorderHover = Color3.fromRGB(255, 255, 255),
    BorderHoverTransparency = 0.7,
    Text = Color3.fromRGB(255, 255, 255),
    TextSecondary = Color3.fromRGB(200, 200, 205),
    TextTertiary = Color3.fromRGB(150, 150, 160),
    Accent = Color3.fromRGB(255, 255, 255),
    AccentTransparency = 0.1,
    AccentHover = Color3.fromRGB(255, 255, 255),
    AccentHoverTransparency = 0.05,
    Success = Color3.fromRGB(200, 200, 205),
    Glow = Color3.fromRGB(255, 255, 255)
}

function Library:Create(className, properties)
    local object = Instance.new(className)
    for i, v in pairs(properties) do
        if i ~= "Parent" then
            object[i] = v
        end
    end
    object.Parent = properties.Parent
    return object
end

local function CreateLoadingScreen()
    local LoadingGui = Instance.new("ScreenGui")
    LoadingGui.Name = "LithiumLoading"
    LoadingGui.Parent = CoreGui
    LoadingGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    
    local Container = Instance.new("Frame")
    Container.Name = "Container"
    Container.Parent = LoadingGui
    Container.BackgroundColor3 = Colors.Background
    Container.BackgroundTransparency = Colors.BackgroundTransparency
    Container.BorderSizePixel = 0
    Container.Position = UDim2.new(0.5, -350, 0.5, -275)
    Container.Size = UDim2.new(0, 700, 0, 550)
    
    local Corner = Instance.new("UICorner")
    Corner.CornerRadius = UDim.new(0, 16)
    Corner.Parent = Container
    
    local GlowStroke = Instance.new("UIStroke")
    GlowStroke.Color = Colors.Border
    GlowStroke.Thickness = 1
    GlowStroke.Transparency = Colors.BorderTransparency
    GlowStroke.Parent = Container
    
    task.spawn(function()
        while LoadingGui.Parent do
            TweenService:Create(GlowStroke, TweenInfo.new(2, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true), {
                Transparency = 0.7
            }):Play()
            task.wait(2)
        end
    end)
    
    local Shadow = Instance.new("ImageLabel")
    Shadow.Name = "Shadow"
    Shadow.Parent = Container
    Shadow.BackgroundTransparency = 1
    Shadow.Position = UDim2.new(0, -20, 0, -20)
    Shadow.Size = UDim2.new(1, 40, 1, 40)
    Shadow.ZIndex = 0
    Shadow.Image = "rbxassetid://5554236805"
    Shadow.ImageColor3 = Color3.fromRGB(0, 0, 0)
    Shadow.ImageTransparency = 0.5
    Shadow.ScaleType = Enum.ScaleType.Slice
    Shadow.SliceCenter = Rect.new(23, 23, 277, 277)
    
    local ContentFrame = Instance.new("Frame")
    ContentFrame.Name = "ContentFrame"
    ContentFrame.Parent = Container
    ContentFrame.BackgroundTransparency = 1
    ContentFrame.Size = UDim2.new(1, 0, 1, 0)
    
    local LogoContainer = Instance.new("Frame")
    LogoContainer.Name = "LogoContainer"
    LogoContainer.Parent = ContentFrame
    LogoContainer.BackgroundTransparency = 1
    LogoContainer.Size = UDim2.new(0, 100, 0, 100)
    LogoContainer.Position = UDim2.new(0.5, -50, 0.25, -50)
    
    local Logo = Instance.new("ImageLabel")
    Logo.Name = "Logo"
    Logo.Parent = LogoContainer
    Logo.BackgroundTransparency = 1
    Logo.Size = UDim2.new(1, 0, 1, 0)
    Logo.Image = LOGO_IMAGE_ID
    Logo.ImageTransparency = 1
    
    local TitleText = Instance.new("TextLabel")
    TitleText.Parent = ContentFrame
    TitleText.BackgroundTransparency = 1
    TitleText.Position = UDim2.new(0.5, 0, 0.5, -10)
    TitleText.Size = UDim2.new(0, 400, 0, 50)
    TitleText.AnchorPoint = Vector2.new(0.5, 0.5)
    TitleText.Font = Enum.Font.GothamBold
    TitleText.Text = "LITHIUM HUB"
    TitleText.TextColor3 = Colors.Text
    TitleText.TextSize = 32
    TitleText.TextTransparency = 1
    
    local Subtitle = Instance.new("TextLabel")
    Subtitle.Parent = ContentFrame
    Subtitle.BackgroundTransparency = 1
    Subtitle.Position = UDim2.new(0.5, 0, 0.5, 30)
    Subtitle.Size = UDim2.new(0, 400, 0, 20)
    Subtitle.AnchorPoint = Vector2.new(0.5, 0.5)
    Subtitle.Font = Enum.Font.Gotham
    Subtitle.Text = "v0.0.3 (PERFECT)"
    Subtitle.TextColor3 = Colors.TextSecondary
    Subtitle.TextSize = 13
    Subtitle.TextTransparency = 1
    
    local ProgressBarBg = Instance.new("Frame")
    ProgressBarBg.Parent = ContentFrame
    ProgressBarBg.BackgroundColor3 = Colors.Secondary
    ProgressBarBg.BackgroundTransparency = Colors.SecondaryTransparency
    ProgressBarBg.BorderSizePixel = 0
    ProgressBarBg.Position = UDim2.new(0, 100, 0.7, 0)
    ProgressBarBg.Size = UDim2.new(1, -200, 0, 4)
    ProgressBarBg.Transparency = 1
    
    local ProgressCorner = Instance.new("UICorner")
    ProgressCorner.CornerRadius = UDim.new(1, 0)
    ProgressCorner.Parent = ProgressBarBg
    
    local ProgressStroke = Instance.new("UIStroke")
    ProgressStroke.Color = Colors.Border
    ProgressStroke.Thickness = 1
    ProgressStroke.Transparency = Colors.BorderTransparency
    ProgressStroke.Parent = ProgressBarBg
    
    local ProgressFill = Instance.new("Frame")
    ProgressFill.Parent = ProgressBarBg
    ProgressFill.BackgroundColor3 = Colors.Accent
    ProgressFill.BackgroundTransparency = Colors.AccentTransparency
    ProgressFill.BorderSizePixel = 0
    ProgressFill.Size = UDim2.new(0, 0, 1, 0)
    
    local FillCorner = Instance.new("UICorner")
    FillCorner.CornerRadius = UDim.new(1, 0)
    FillCorner.Parent = ProgressFill
    
    local StatusText = Instance.new("TextLabel")
    StatusText.Parent = ContentFrame
    StatusText.BackgroundTransparency = 1
    StatusText.Position = UDim2.new(0.5, 0, 0.76, 0)
    StatusText.Size = UDim2.new(0, 400, 0, 20)
    StatusText.AnchorPoint = Vector2.new(0.5, 0)
    StatusText.Font = Enum.Font.Gotham
    StatusText.Text = "Initializing..."
    StatusText.TextColor3 = Colors.TextTertiary
    StatusText.TextSize = 11
    StatusText.TextTransparency = 1
    
    task.spawn(function()
        for i = 1, 20 do
            local alpha = i / 20
            Logo.ImageTransparency = 1 - alpha
            task.wait(0.02)
        end
        
        task.wait(0.1)
        
        for i = 1, 15 do
            local alpha = i / 15
            TitleText.TextTransparency = 1 - alpha
            Subtitle.TextTransparency = 1 - alpha
            task.wait(0.02)
        end
        
        task.wait(0.1)
        
        for i = 1, 15 do
            local alpha = i / 15
            ProgressBarBg.Transparency = 1 - alpha
            ProgressStroke.Transparency = Colors.BorderTransparency + ((1 - Colors.BorderTransparency) * (1 - alpha))
            StatusText.TextTransparency = 1 - alpha
            task.wait(0.02)
        end
        
        local stages = {
            {progress = 0.2, text = "Loading hooks..."},
            {progress = 0.4, text = "Setting up environment..."},
            {progress = 0.6, text = "Initializing systems..."},
            {progress = 0.8, text = "Preparing interface..."},
            {progress = 1.0, text = "Ready!"}
        }
        
        for _, stage in ipairs(stages) do
            StatusText.Text = stage.text
            TweenService:Create(ProgressFill, TweenInfo.new(0.5, Enum.EasingStyle.Exponential, Enum.EasingDirection.Out), {
                Size = UDim2.new(stage.progress, 0, 1, 0)
            }):Play()
            task.wait(0.6)
        end
        
        task.wait(0.3)
        
        for i = 1, 20 do
            local alpha = i / 20
            Container.BackgroundTransparency = Colors.BackgroundTransparency + ((1 - Colors.BackgroundTransparency) * alpha)
            GlowStroke.Transparency = Colors.BorderTransparency + ((1 - Colors.BorderTransparency) * alpha)
            Shadow.ImageTransparency = 0.5 + (0.5 * alpha)
            Logo.ImageTransparency = alpha
            TitleText.TextTransparency = alpha
            Subtitle.TextTransparency = alpha
            ProgressBarBg.Transparency = alpha
            ProgressStroke.Transparency = 1
            StatusText.TextTransparency = alpha
            task.wait(0.02)
        end
        
        LoadingGui:Destroy()
    end)
    
    return LoadingGui
end

function Library:CreateWindow(title)
    local Window = {}
    
    if CoreGui:FindFirstChild("LithiumGUI") then
        CoreGui:FindFirstChild("LithiumGUI"):Destroy()
    end
    
    local ScreenGui = self:Create("ScreenGui", {
        Name = "LithiumGUI",
        Parent = CoreGui,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling,
        ResetOnSpawn = false
    })
    
    local MainFrame = self:Create("Frame", {
        Name = "MainFrame",
        Parent = ScreenGui,
        BackgroundColor3 = Colors.Background,
        BackgroundTransparency = Colors.BackgroundTransparency,
        BorderSizePixel = 0,
        Position = UDim2.new(0.5, -350, 0.5, -275),
        Size = UDim2.new(0, 700, 0, 550),
        Active = true,
        Draggable = true
    })
    
    self:Create("UICorner", {
        CornerRadius = UDim.new(0, 16),
        Parent = MainFrame
    })
    
    local MainStroke = self:Create("UIStroke", {
        Color = Colors.Border,
        Thickness = 1,
        Transparency = Colors.BorderTransparency,
        Parent = MainFrame
    })
    
    task.spawn(function()
        while MainFrame.Parent do
            TweenService:Create(MainStroke, TweenInfo.new(2, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true), {
                Transparency = 0.7
            }):Play()
            task.wait(2)
        end
    end)
    
    local Shadow = self:Create("ImageLabel", {
        Name = "Shadow",
        Parent = MainFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, -20, 0, -20),
        Size = UDim2.new(1, 40, 1, 40),
        ZIndex = 0,
        Image = "rbxassetid://5554236805",
        ImageColor3 = Color3.fromRGB(0, 0, 0),
        ImageTransparency = 0.5,
        ScaleType = Enum.ScaleType.Slice,
        SliceCenter = Rect.new(23, 23, 277, 277)
    })
    
    local Header = self:Create("Frame", {
        Name = "Header",
        Parent = MainFrame,
        BackgroundColor3 = Colors.Secondary,
        BackgroundTransparency = Colors.SecondaryTransparency,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 50)
    })
    
    self:Create("UICorner", {
        CornerRadius = UDim.new(0, 16),
        Parent = Header
    })
    
    local HeaderStroke = self:Create("UIStroke", {
        Color = Colors.Border,
        Thickness = 1,
        Transparency = Colors.BorderTransparency,
        Parent = Header
    })
    
    local HeaderDivider = self:Create("Frame", {
        Name = "Divider",
        Parent = Header,
        BackgroundColor3 = Colors.Border,
        BackgroundTransparency = Colors.BorderTransparency,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 1, -1),
        Size = UDim2.new(1, 0, 0, 1)
    })
    
    local Title = self:Create("TextLabel", {
        Name = "Title",
        Parent = Header,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 20, 0, 0),
        Size = UDim2.new(1, -100, 1, 0),
        Font = Enum.Font.GothamBold,
        Text = title,
        TextColor3 = Colors.Text,
        TextSize = 17,
        TextXAlignment = Enum.TextXAlignment.Left
    })
    
    local Version = self:Create("TextLabel", {
        Name = "Version",
        Parent = Header,
        BackgroundTransparency = 1,
        Position = UDim2.new(1, -110, 0, 0),
        Size = UDim2.new(0, 80, 1, 0),
        Font = Enum.Font.Gotham,
        Text = "v0.0.3 (PERFECT)",
        TextColor3 = Colors.TextSecondary,
        TextSize = 10,
        TextXAlignment = Enum.TextXAlignment.Right
    })
    
    local CloseButton = self:Create("TextButton", {
        Name = "CloseButton",
        Parent = Header,
        BackgroundColor3 = Color3.fromRGB(200, 50, 50),
        BackgroundTransparency = 0.2,
        BorderSizePixel = 0,
        Position = UDim2.new(1, -35, 0.5, -12),
        Size = UDim2.new(0, 24, 0, 24),
        Font = Enum.Font.GothamBold,
        Text = "×",
        TextColor3 = Colors.Text,
        TextSize = 18,
        AutoButtonColor = false
    })
    
    self:Create("UICorner", {
        CornerRadius = UDim.new(1, 0),
        Parent = CloseButton
    })
    
    CloseButton.MouseEnter:Connect(function()
        TweenService:Create(CloseButton, TweenInfo.new(0.2, Enum.EasingStyle.Exponential), {
            BackgroundTransparency = 0
        }):Play()
    end)
    
    CloseButton.MouseLeave:Connect(function()
        TweenService:Create(CloseButton, TweenInfo.new(0.2, Enum.EasingStyle.Exponential), {
            BackgroundTransparency = 0.2
        }):Play()
    end)
    
    CloseButton.MouseButton1Click:Connect(function()
        ScreenGui:Destroy()
    end)
    
    local TabsContainer = self:Create("Frame", {
        Name = "TabsContainer",
        Parent = MainFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 10, 0, 60),
        Size = UDim2.new(0, 140, 1, -70)
    })
    
    local TabList = self:Create("UIListLayout", {
        Parent = TabsContainer,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 6)
    })
    
    local ContentContainer = self:Create("Frame", {
        Name = "ContentContainer",
        Parent = MainFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 160, 0, 60),
        Size = UDim2.new(1, -170, 1, -70)
    })
    
    Window.Tabs = {}
    Window.ScreenGui = ScreenGui
    Window.MainFrame = MainFrame
    Window.TabsContainer = TabsContainer
    Window.ContentContainer = ContentContainer
    
    function Window:CreateTab(name, icon)
        local Tab = {}
        
        local TabButton = self:Create("TextButton", {
            Name = name .. "Button",
            Parent = self.TabsContainer,
            BackgroundColor3 = Colors.Tertiary,
            BackgroundTransparency = Colors.TertiaryTransparency,
            BorderSizePixel = 0,
            Size = UDim2.new(1, 0, 0, 38),
            Font = Enum.Font.GothamSemibold,
            Text = (icon and icon .. " " or "") .. name,
            TextColor3 = Colors.TextSecondary,
            TextSize = 12,
            TextXAlignment = Enum.TextXAlignment.Left,
            AutoButtonColor = false
        })
        
        self:Create("UICorner", {
            CornerRadius = UDim.new(0, 10),
            Parent = TabButton
        })
        
        local TabStroke = self:Create("UIStroke", {
            Color = Colors.Border,
            Thickness = 1,
            Transparency = Colors.BorderTransparency,
            Parent = TabButton
        })
        
        self:Create("UIPadding", {
            Parent = TabButton,
            PaddingLeft = UDim.new(0, 15)
        })
        
        local TabContent = self:Create("ScrollingFrame", {
            Name = name .. "Content",
            Parent = self.ContentContainer,
            Active = true,
            BackgroundTransparency = 1,
            BorderSizePixel = 0,
            Size = UDim2.new(1, 0, 1, 0),
            CanvasSize = UDim2.new(0, 0, 0, 0),
            ScrollBarThickness = 3,
            ScrollBarImageColor3 = Colors.Accent,
            ScrollBarImageTransparency = 0.5,
            Visible = false
        })
        
        local ContentList = self:Create("UIListLayout", {
            Parent = TabContent,
            SortOrder = Enum.SortOrder.LayoutOrder,
            Padding = UDim.new(0, 8)
        })
        
        self:Create("UIPadding", {
            Parent = TabContent,
            PaddingTop = UDim.new(0, 10),
            PaddingLeft = UDim.new(0, 10),
            PaddingRight = UDim.new(0, 10),
            PaddingBottom = UDim.new(0, 10)
        })
        
        ContentList:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
            TabContent.CanvasSize = UDim2.new(0, 0, 0, ContentList.AbsoluteContentSize.Y + 20)
        end)
        
        TabButton.MouseEnter:Connect(function()
            if not Tab.Active then
                TweenService:Create(TabButton, TweenInfo.new(0.2, Enum.EasingStyle.Exponential), {
                    BackgroundTransparency = Colors.CardHoverTransparency
                }):Play()
                TweenService:Create(TabStroke, TweenInfo.new(0.2, Enum.EasingStyle.Exponential), {
                    Transparency = Colors.BorderHoverTransparency
                }):Play()
            end
        end)
        
        TabButton.MouseLeave:Connect(function()
            if not Tab.Active then
                TweenService:Create(TabButton, TweenInfo.new(0.2, Enum.EasingStyle.Exponential), {
                    BackgroundTransparency = Colors.TertiaryTransparency
                }):Play()
                TweenService:Create(TabStroke, TweenInfo.new(0.2, Enum.EasingStyle.Exponential), {
                    Transparency = Colors.BorderTransparency
                }):Play()
            end
        end)
        
        TabButton.MouseButton1Click:Connect(function()
            for _, tab in pairs(self.Tabs) do
                TweenService:Create(tab.Button, TweenInfo.new(0.2, Enum.EasingStyle.Exponential), {
                    BackgroundTransparency = Colors.TertiaryTransparency,
                    TextColor3 = Colors.TextSecondary
                }):Play()
                TweenService:Create(tab.Stroke, TweenInfo.new(0.2, Enum.EasingStyle.Exponential), {
                    Transparency = Colors.BorderTransparency
                }):Play()
                tab.Content.Visible = false
                tab.Active = false
            end
            
            TweenService:Create(TabButton, TweenInfo.new(0.2, Enum.EasingStyle.Exponential), {
                BackgroundTransparency = Colors.AccentTransparency,
                TextColor3 = Colors.Text
            }):Play()
            
            TweenService:Create(TabStroke, TweenInfo.new(0.2, Enum.EasingStyle.Exponential), {
                Transparency = 0.5
            }):Play()
            
            TabContent.Visible = true
            Tab.Active = true
        end)
        
        Tab.Button = TabButton
        Tab.Stroke = TabStroke
        Tab.Content = TabContent
        Tab.Window = self
        Tab.Active = false
        
        table.insert(self.Tabs, Tab)
        
        if #self.Tabs == 1 then
            TabButton.BackgroundTransparency = Colors.AccentTransparency
            TabButton.TextColor3 = Colors.Text
            TabStroke.Transparency = 0.5
            TabContent.Visible = true
            Tab.Active = true
        end
        
        return setmetatable(Tab, {__index = Library})
    end
    
    return setmetatable(Window, {__index = Library})
end

function Library:CreateLabel(text)
    local Label = self:Create("TextLabel", {
        Name = "Label",
        Parent = self.Content,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, -20, 0, 20),
        Font = Enum.Font.Gotham,
        Text = text,
        TextColor3 = Colors.TextTertiary,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextWrapped = true
    })
    
    return Label
end

function Library:CreateToggle(name, default, callback)
    local Toggle = {}
    Toggle.Value = default or false
    
    local ToggleFrame = self:Create("Frame", {
        Name = name .. "Toggle",
        Parent = self.Content,
        BackgroundColor3 = Colors.Card,
        BackgroundTransparency = Colors.CardTransparency,
        BorderSizePixel = 0,
        Size = UDim2.new(1, -20, 0, 45)
    })
    
    self:Create("UICorner", {
        CornerRadius = UDim.new(0, 10),
        Parent = ToggleFrame
    })
    
    local ToggleStroke = self:Create("UIStroke", {
        Color = Colors.Border,
        Thickness = 1,
        Transparency = Colors.BorderTransparency,
        Parent = ToggleFrame
    })
    
    local ToggleButton = self:Create("TextButton", {
        Name = "Button",
        Parent = ToggleFrame,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, 0),
        Text = "",
        AutoButtonColor = false
    })
    
    local ToggleLabel = self:Create("TextLabel", {
        Name = "Label",
        Parent = ToggleButton,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 15, 0, 0),
        Size = UDim2.new(1, -70, 1, 0),
        Font = Enum.Font.GothamSemibold,
        Text = name,
        TextColor3 = Colors.Text,
        TextSize = 12,
        TextXAlignment = Enum.TextXAlignment.Left
    })
    
    local ToggleSwitch = self:Create("Frame", {
        Name = "Switch",
        Parent = ToggleButton,
        BackgroundColor3 = Toggle.Value and Colors.Accent or Colors.Secondary,
        BackgroundTransparency = Toggle.Value and Colors.AccentTransparency or Colors.SecondaryTransparency,
        BorderSizePixel = 0,
        Position = UDim2.new(1, -50, 0.5, -10),
        Size = UDim2.new(0, 40, 0, 20)
    })
    
    self:Create("UICorner", {
        CornerRadius = UDim.new(1, 0),
        Parent = ToggleSwitch
    })
    
    local SwitchStroke = self:Create("UIStroke", {
        Color = Toggle.Value and Colors.Glow or Colors.Border,
        Thickness = 1,
        Transparency = Toggle.Value and 0.5 or Colors.BorderTransparency,
        Parent = ToggleSwitch
    })
    
    local ToggleCircle = self:Create("Frame", {
        Name = "Circle",
        Parent = ToggleSwitch,
        BackgroundColor3 = Colors.Text,
        BorderSizePixel = 0,
        Position = Toggle.Value and UDim2.new(1, -18, 0.5, -8) or UDim2.new(0, 2, 0.5, -8),
        Size = UDim2.new(0, 16, 0, 16)
    })
    
    self:Create("UICorner", {
        CornerRadius = UDim.new(1, 0),
        Parent = ToggleCircle
    })
    
    function Toggle:Set(value)
        self.Value = value
        
        TweenService:Create(ToggleSwitch, TweenInfo.new(0.3, Enum.EasingStyle.Exponential), {
            BackgroundColor3 = value and Colors.Accent or Colors.Secondary,
            BackgroundTransparency = value and Colors.AccentTransparency or Colors.SecondaryTransparency
        }):Play()
        
        TweenService:Create(SwitchStroke, TweenInfo.new(0.3, Enum.EasingStyle.Exponential), {
            Color = value and Colors.Glow or Colors.Border,
            Transparency = value and 0.5 or Colors.BorderTransparency
        }):Play()
        
        TweenService:Create(ToggleCircle, TweenInfo.new(0.3, Enum.EasingStyle.Sine), {
            Position = value and UDim2.new(1, -18, 0.5, -8) or UDim2.new(0, 2, 0.5, -8)
        }):Play()
        
        if callback then
            task.spawn(callback, value)
        end
    end
    
    ToggleButton.MouseButton1Click:Connect(function()
        Toggle:Set(not Toggle.Value)
    end)
    
    ToggleFrame.MouseEnter:Connect(function()
        TweenService:Create(ToggleStroke, TweenInfo.new(0.2, Enum.EasingStyle.Exponential), {
            Transparency = Colors.BorderHoverTransparency
        }):Play()
    end)
    
    ToggleFrame.MouseLeave:Connect(function()
        TweenService:Create(ToggleStroke, TweenInfo.new(0.2, Enum.EasingStyle.Exponential), {
            Transparency = Colors.BorderTransparency
        }):Play()
    end)
    
    return Toggle
end

function Library:CreateButton(name, callback)
    local ButtonFrame = self:Create("Frame", {
        Name = name .. "Button",
        Parent = self.Content,
        BackgroundColor3 = Colors.Accent,
        BackgroundTransparency = Colors.AccentTransparency,
        BorderSizePixel = 0,
        Size = UDim2.new(1, -20, 0, 40)
    })
    
    self:Create("UICorner", {
        CornerRadius = UDim.new(0, 10),
        Parent = ButtonFrame
    })
    
    local ButtonStroke = self:Create("UIStroke", {
        Color = Colors.Glow,
        Thickness = 1,
        Transparency = 0.7,
        Parent = ButtonFrame
    })
    
    local Button = self:Create("TextButton", {
        Name = "Button",
        Parent = ButtonFrame,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, 0),
        Font = Enum.Font.GothamBold,
        Text = name,
        TextColor3 = Colors.Text,
        TextSize = 13,
        AutoButtonColor = false
    })
    
    Button.MouseEnter:Connect(function()
        TweenService:Create(ButtonFrame, TweenInfo.new(0.2, Enum.EasingStyle.Exponential), {
            BackgroundTransparency = Colors.AccentHoverTransparency
        }):Play()
        TweenService:Create(ButtonStroke, TweenInfo.new(0.2, Enum.EasingStyle.Exponential), {
            Transparency = 0.5
        }):Play()
    end)
    
    Button.MouseLeave:Connect(function()
        TweenService:Create(ButtonFrame, TweenInfo.new(0.2, Enum.EasingStyle.Exponential), {
            BackgroundTransparency = Colors.AccentTransparency
        }):Play()
        TweenService:Create(ButtonStroke, TweenInfo.new(0.2, Enum.EasingStyle.Exponential), {
            Transparency = 0.7
        }):Play()
    end)
    
    Button.MouseButton1Click:Connect(function()
        if callback then
            task.spawn(callback)
        end
    end)
    
    return Button
end

function Library:CreateDropdown(name, options, default, callback)
    local Dropdown = {}
    Dropdown.Value = default or options[1]
    Dropdown.Options = options
    Dropdown.Open = false
    local Lib = self
    
    local DropdownFrame = self:Create("Frame", {
        Name = name .. "Dropdown",
        Parent = self.Content,
        BackgroundColor3 = Colors.Card,
        BackgroundTransparency = Colors.CardTransparency,
        BorderSizePixel = 0,
        Size = UDim2.new(1, -20, 0, 75),
        ClipsDescendants = true
    })
    
    self:Create("UICorner", {
        CornerRadius = UDim.new(0, 10),
        Parent = DropdownFrame
    })
    
    self:Create("UIStroke", {
        Color = Colors.Border,
        Thickness = 1,
        Transparency = Colors.BorderTransparency,
        Parent = DropdownFrame
    })
    
    local DropdownLabel = self:Create("TextLabel", {
        Name = "Label",
        Parent = DropdownFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 15, 0, 8),
        Size = UDim2.new(1, -30, 0, 18),
        Font = Enum.Font.GothamSemibold,
        Text = name,
        TextColor3 = Colors.Text,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left
    })
    
    local DropdownButton = self:Create("TextButton", {
        Name = "Button",
        Parent = DropdownFrame,
        BackgroundColor3 = Colors.Secondary,
        BackgroundTransparency = Colors.SecondaryTransparency,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 10, 0, 32),
        Size = UDim2.new(1, -20, 0, 32),
        Font = Enum.Font.Gotham,
        Text = Dropdown.Value,
        TextColor3 = Colors.Text,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
        AutoButtonColor = false
    })
    
    self:Create("UICorner", {
        CornerRadius = UDim.new(0, 8),
        Parent = DropdownButton
    })
    
    self:Create("UIStroke", {
        Color = Colors.Border,
        Thickness = 1,
        Transparency = Colors.BorderTransparency,
        Parent = DropdownButton
    })
    
    self:Create("UIPadding", {
        Parent = DropdownButton,
        PaddingLeft = UDim.new(0, 12),
        PaddingRight = UDim.new(0, 12)
    })
    
    local Arrow = self:Create("TextLabel", {
        Name = "Arrow",
        Parent = DropdownButton,
        BackgroundTransparency = 1,
        Position = UDim2.new(1, -25, 0, 0),
        Size = UDim2.new(0, 20, 1, 0),
        Font = Enum.Font.GothamBold,
        Text = "▼",
        TextColor3 = Colors.TextSecondary,
        TextSize = 9
    })
    
    local OptionsContainer = self:Create("ScrollingFrame", {
        Name = "Options",
        Parent = DropdownFrame,
        BackgroundColor3 = Colors.Secondary,
        BackgroundTransparency = Colors.SecondaryTransparency,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 10, 0, 70),
        Size = UDim2.new(1, -20, 0, 0),
        CanvasSize = UDim2.new(0, 0, 0, 0),
        ScrollBarThickness = 2,
        ScrollBarImageColor3 = Colors.Accent,
        ScrollBarImageTransparency = 0.5,
        ClipsDescendants = true
    })
    
    self:Create("UICorner", {
        CornerRadius = UDim.new(0, 8),
        Parent = OptionsContainer
    })
    
    self:Create("UIStroke", {
        Color = Colors.Border,
        Thickness = 1,
        Transparency = Colors.BorderTransparency,
        Parent = OptionsContainer
    })
    
    local OptionsList = self:Create("UIListLayout", {
        Parent = OptionsContainer,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 2)
    })
    
    self:Create("UIPadding", {
        Parent = OptionsContainer,
        PaddingTop = UDim.new(0, 5),
        PaddingBottom = UDim.new(0, 5)
    })
    
    OptionsList:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        OptionsContainer.CanvasSize = UDim2.new(0, 0, 0, OptionsList.AbsoluteContentSize.Y + 10)
    end)
    
    function Dropdown:Set(value)
        self.Value = value
        DropdownButton.Text = value
        
        if callback then
            task.spawn(callback, value)
        end
    end
    
    function Dropdown:Refresh(newOptions)
        for _, child in pairs(OptionsContainer:GetChildren()) do
            if child:IsA("TextButton") then
                child:Destroy()
            end
        end
        
        self.Options = newOptions
        
        for _, option in ipairs(newOptions) do
            local OptionButton = Lib:Create("TextButton", {
                Name = option,
                Parent = OptionsContainer,
                BackgroundColor3 = Colors.Tertiary,
                BackgroundTransparency = Colors.TertiaryTransparency,
                BorderSizePixel = 0,
                Size = UDim2.new(1, -6, 0, 26),
                Font = Enum.Font.Gotham,
                Text = option,
                TextColor3 = Colors.TextSecondary,
                TextSize = 10,
                TextXAlignment = Enum.TextXAlignment.Left,
                AutoButtonColor = false
            })
            
            Lib:Create("UICorner", {
                CornerRadius = UDim.new(0, 6),
                Parent = OptionButton
            })
            
            Lib:Create("UIPadding", {
                Parent = OptionButton,
                PaddingLeft = UDim.new(0, 10)
            })
            
            OptionButton.MouseEnter:Connect(function()
                TweenService:Create(OptionButton, TweenInfo.new(0.2, Enum.EasingStyle.Exponential), {
                    BackgroundTransparency = Colors.AccentTransparency,
                    TextColor3 = Colors.Text
                }):Play()
            end)
            
            OptionButton.MouseLeave:Connect(function()
                TweenService:Create(OptionButton, TweenInfo.new(0.2, Enum.EasingStyle.Exponential), {
                    BackgroundTransparency = Colors.TertiaryTransparency,
                    TextColor3 = Colors.TextSecondary
                }):Play()
            end)
            
            OptionButton.MouseButton1Click:Connect(function()
                Dropdown:Set(option)
                Dropdown:Toggle()
            end)
        end
    end
    
    function Dropdown:Toggle()
        self.Open = not self.Open
        
        local targetSize = self.Open and UDim2.new(1, -20, 0, math.min(#self.Options * 28 + 10, 150)) or UDim2.new(1, -20, 0, 0)
        local targetFrameSize = self.Open and UDim2.new(1, -20, 0, 75 + math.min(#self.Options * 28 + 10, 150)) or UDim2.new(1, -20, 0, 75)
        
        TweenService:Create(OptionsContainer, TweenInfo.new(0.2, Enum.EasingStyle.Exponential), {Size = targetSize}):Play()
        TweenService:Create(DropdownFrame, TweenInfo.new(0.2, Enum.EasingStyle.Exponential), {Size = targetFrameSize}):Play()
        TweenService:Create(Arrow, TweenInfo.new(0.2, Enum.EasingStyle.Exponential), {Rotation = self.Open and 180 or 0}):Play()
    end
    
    DropdownButton.MouseButton1Click:Connect(function()
        Dropdown:Toggle()
    end)
    
    Dropdown:Refresh(options)
    
    return Dropdown
end

function Library:CreateMultiDropdown(name, options, defaults, callback)
    local MultiDropdown = {}
    MultiDropdown.Values = defaults or {}
    MultiDropdown.Options = options
    MultiDropdown.Open = false
    local Lib = self
    
    local DropdownFrame = self:Create("Frame", {
        Name = name .. "MultiDropdown",
        Parent = self.Content,
        BackgroundColor3 = Colors.Card,
        BackgroundTransparency = Colors.CardTransparency,
        BorderSizePixel = 0,
        Size = UDim2.new(1, -20, 0, 75),
        ClipsDescendants = true
    })
    
    self:Create("UICorner", {
        CornerRadius = UDim.new(0, 10),
        Parent = DropdownFrame
    })
    
    self:Create("UIStroke", {
        Color = Colors.Border,
        Thickness = 1,
        Transparency = Colors.BorderTransparency,
        Parent = DropdownFrame
    })
    
    local DropdownLabel = self:Create("TextLabel", {
        Name = "Label",
        Parent = DropdownFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 15, 0, 8),
        Size = UDim2.new(1, -30, 0, 18),
        Font = Enum.Font.GothamSemibold,
        Text = name,
        TextColor3 = Colors.Text,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left
    })
    
    local DropdownButton = self:Create("TextButton", {
        Name = "Button",
        Parent = DropdownFrame,
        BackgroundColor3 = Colors.Secondary,
        BackgroundTransparency = Colors.SecondaryTransparency,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 10, 0, 32),
        Size = UDim2.new(1, -20, 0, 32),
        Font = Enum.Font.Gotham,
        Text = #MultiDropdown.Values > 0 and table.concat(MultiDropdown.Values, ", ") or "None Selected",
        TextColor3 = Colors.Text,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
        AutoButtonColor = false
    })
    
    self:Create("UICorner", {
        CornerRadius = UDim.new(0, 8),
        Parent = DropdownButton
    })
    
    self:Create("UIStroke", {
        Color = Colors.Border,
        Thickness = 1,
        Transparency = Colors.BorderTransparency,
        Parent = DropdownButton
    })
    
    self:Create("UIPadding", {
        Parent = DropdownButton,
        PaddingLeft = UDim.new(0, 12),
        PaddingRight = UDim.new(0, 12)
    })
    
    local Arrow = self:Create("TextLabel", {
        Name = "Arrow",
        Parent = DropdownButton,
        BackgroundTransparency = 1,
        Position = UDim2.new(1, -25, 0, 0),
        Size = UDim2.new(0, 20, 1, 0),
        Font = Enum.Font.GothamBold,
        Text = "▼",
        TextColor3 = Colors.TextSecondary,
        TextSize = 9
    })
    
    local OptionsContainer = self:Create("ScrollingFrame", {
        Name = "Options",
        Parent = DropdownFrame,
        BackgroundColor3 = Colors.Secondary,
        BackgroundTransparency = Colors.SecondaryTransparency,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 10, 0, 70),
        Size = UDim2.new(1, -20, 0, 0),
        CanvasSize = UDim2.new(0, 0, 0, 0),
        ScrollBarThickness = 2,
        ScrollBarImageColor3 = Colors.Accent,
        ScrollBarImageTransparency = 0.5,
        ClipsDescendants = true
    })
    
    self:Create("UICorner", {
        CornerRadius = UDim.new(0, 8),
        Parent = OptionsContainer
    })
    
    self:Create("UIStroke", {
        Color = Colors.Border,
        Thickness = 1,
        Transparency = Colors.BorderTransparency,
        Parent = OptionsContainer
    })
    
    local OptionsList = self:Create("UIListLayout", {
        Parent = OptionsContainer,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 2)
    })
    
    self:Create("UIPadding", {
        Parent = OptionsContainer,
        PaddingTop = UDim.new(0, 5),
        PaddingBottom = UDim.new(0, 5)
    })
    
    OptionsList:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        OptionsContainer.CanvasSize = UDim2.new(0, 0, 0, OptionsList.AbsoluteContentSize.Y + 10)
    end)
    
    function MultiDropdown:UpdateText()
        DropdownButton.Text = #self.Values > 0 and table.concat(self.Values, ", ") or "None Selected"
    end
    
    function MultiDropdown:Add(value)
        if not table.find(self.Values, value) then
            table.insert(self.Values, value)
            self:UpdateText()
            if callback then
                task.spawn(callback, self.Values)
            end
        end
    end
    
    function MultiDropdown:Remove(value)
        local index = table.find(self.Values, value)
        if index then
            table.remove(self.Values, index)
            self:UpdateText()
            if callback then
                task.spawn(callback, self.Values)
            end
        end
    end
    
    function MultiDropdown:Toggle()
        self.Open = not self.Open
        
        local targetSize = self.Open and UDim2.new(1, -20, 0, math.min(#self.Options * 28 + 10, 150)) or UDim2.new(1, -20, 0, 0)
        local targetFrameSize = self.Open and UDim2.new(1, -20, 0, 75 + math.min(#self.Options * 28 + 10, 150)) or UDim2.new(1, -20, 0, 75)
        
        TweenService:Create(OptionsContainer, TweenInfo.new(0.2, Enum.EasingStyle.Exponential), {Size = targetSize}):Play()
        TweenService:Create(DropdownFrame, TweenInfo.new(0.2, Enum.EasingStyle.Exponential), {Size = targetFrameSize}):Play()
        TweenService:Create(Arrow, TweenInfo.new(0.2, Enum.EasingStyle.Exponential), {Rotation = self.Open and 180 or 0}):Play()
    end
    
    for _, option in ipairs(options) do
        local OptionFrame = Lib:Create("Frame", {
            Name = option .. "Frame",
            Parent = OptionsContainer,
            BackgroundColor3 = Colors.Tertiary,
            BackgroundTransparency = Colors.TertiaryTransparency,
            BorderSizePixel = 0,
            Size = UDim2.new(1, -6, 0, 26)
        })
        
        Lib:Create("UICorner", {
            CornerRadius = UDim.new(0, 6),
            Parent = OptionFrame
        })
        
        local OptionButton = Lib:Create("TextButton", {
            Name = option,
            Parent = OptionFrame,
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 1, 0),
            Font = Enum.Font.Gotham,
            Text = option,
            TextColor3 = Colors.TextSecondary,
            TextSize = 10,
            TextXAlignment = Enum.TextXAlignment.Left,
            AutoButtonColor = false
        })
        
        Lib:Create("UIPadding", {
            Parent = OptionButton,
            PaddingLeft = UDim.new(0, 10)
        })
        
        local Checkbox = Lib:Create("Frame", {
            Name = "Checkbox",
            Parent = OptionButton,
            BackgroundColor3 = Colors.Secondary,
            BackgroundTransparency = Colors.SecondaryTransparency,
            BorderSizePixel = 0,
            Position = UDim2.new(1, -22, 0.5, -8),
            Size = UDim2.new(0, 16, 0, 16)
        })
        
        Lib:Create("UICorner", {
            CornerRadius = UDim.new(0, 4),
            Parent = Checkbox
        })
        
        Lib:Create("UIStroke", {
            Color = Colors.Border,
            Thickness = 1,
            Transparency = Colors.BorderTransparency,
            Parent = Checkbox
        })
        
        local Checkmark = Lib:Create("TextLabel", {
            Name = "Checkmark",
            Parent = Checkbox,
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 1, 0),
            Font = Enum.Font.GothamBold,
            Text = "✓",
            TextColor3 = Colors.Accent,
            TextSize = 11,
            Visible = table.find(MultiDropdown.Values, option) ~= nil
        })
        
        OptionButton.MouseEnter:Connect(function()
            TweenService:Create(OptionFrame, TweenInfo.new(0.2, Enum.EasingStyle.Exponential), {
                BackgroundTransparency = Colors.CardHoverTransparency
            }):Play()
        end)
        
        OptionButton.MouseLeave:Connect(function()
            TweenService:Create(OptionFrame, TweenInfo.new(0.2, Enum.EasingStyle.Exponential), {
                BackgroundTransparency = Colors.TertiaryTransparency
            }):Play()
        end)
        
        OptionButton.MouseButton1Click:Connect(function()
            if table.find(MultiDropdown.Values, option) then
                MultiDropdown:Remove(option)
                Checkmark.Visible = false
            else
                MultiDropdown:Add(option)
                Checkmark.Visible = true
            end
        end)
    end
    
    DropdownButton.MouseButton1Click:Connect(function()
        MultiDropdown:Toggle()
    end)
    
    return MultiDropdown
end

function Library:CreateTextBox(name, default, placeholder, callback)
    local TextBoxObj = {}
    TextBoxObj.Value = default or ""
    
    local TextBoxFrame = self:Create("Frame", {
        Name = name .. "TextBox",
        Parent = self.Content,
        BackgroundColor3 = Colors.Card,
        BackgroundTransparency = Colors.CardTransparency,
        BorderSizePixel = 0,
        Size = UDim2.new(1, -20, 0, 60)
    })
    
    self:Create("UICorner", {
        CornerRadius = UDim.new(0, 10),
        Parent = TextBoxFrame
    })
    
    self:Create("UIStroke", {
        Color = Colors.Border,
        Thickness = 1,
        Transparency = Colors.BorderTransparency,
        Parent = TextBoxFrame
    })
    
    local TextBoxLabel = self:Create("TextLabel", {
        Name = "Label",
        Parent = TextBoxFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 15, 0, 8),
        Size = UDim2.new(1, -30, 0, 18),
        Font = Enum.Font.GothamSemibold,
        Text = name,
        TextColor3 = Colors.Text,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left
    })
    
    local TextBox = self:Create("TextBox", {
        Name = "TextBox",
        Parent = TextBoxFrame,
        BackgroundColor3 = Colors.Secondary,
        BackgroundTransparency = Colors.SecondaryTransparency,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 10, 0, 30),
        Size = UDim2.new(1, -20, 0, 25),
        Font = Enum.Font.Gotham,
        Text = TextBoxObj.Value,
        PlaceholderText = placeholder or "",
        TextColor3 = Colors.Text,
        PlaceholderColor3 = Colors.TextTertiary,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
        ClearTextOnFocus = false
    })
    
    self:Create("UICorner", {
        CornerRadius = UDim.new(0, 6),
        Parent = TextBox
    })
    
    self:Create("UIStroke", {
        Color = Colors.Border,
        Thickness = 1,
        Transparency = Colors.BorderTransparency,
        Parent = TextBox
    })
    
    self:Create("UIPadding", {
        Parent = TextBox,
        PaddingLeft = UDim.new(0, 10),
        PaddingRight = UDim.new(0, 10)
    })
    
    TextBox.FocusLost:Connect(function()
        TextBoxObj.Value = TextBox.Text
        if callback then
            task.spawn(callback, TextBox.Text)
        end
    end)
    
    function TextBoxObj:Set(value)
        self.Value = value
        TextBox.Text = value
        if callback then
            task.spawn(callback, value)
        end
    end
    
    return TextBoxObj
end

-- ═══════════════════════════════════════
-- CORE FUNCTIONS
-- ═══════════════════════════════════════

local PlaceID = game.PlaceId
local AllIDs = {}
local foundAnything = ""
local actualHour = os.date("!*t").hour
local isTeleporting = false  -- ✅ Флаг, чтобы не телепортировать несколько раз
local lastRequestTime = 0  -- ✅ И ЭТУ ТОЖЕ!

local function TPReturner()
    local Site
    
    -- ✅ Защита от слишком частых запросов
    local lastRequestTime = lastRequestTime or 0
    if tick() - lastRequestTime < 2 then
        print("[Lithium] Waiting before next API request...")
        task.wait(2 - (tick() - lastRequestTime))
    end
    lastRequestTime = tick()
    
    -- ✅ HTTP запрос с обработкой ошибок
    local success, result = pcall(function()
        if foundAnything == "" then
            return game.HttpService:JSONDecode(game:HttpGet('https://games.roblox.com/v1/games/' .. PlaceID .. '/servers/Public?sortOrder=' .. Config.SortOrder .. '&limit=100'))
        else
            return game.HttpService:JSONDecode(game:HttpGet('https://games.roblox.com/v1/games/' .. PlaceID .. '/servers/Public?sortOrder=' .. Config.SortOrder .. '&limit=100&cursor=' .. foundAnything))
        end
    end)
    
    if not success then
        warn("[Lithium] HTTP request failed:", result)
        return
    end
    
    Site = result
    
    local ID = ""
    if Site.nextPageCursor and Site.nextPageCursor ~= "null" and Site.nextPageCursor ~= nil then
        foundAnything = Site.nextPageCursor
    end
    
    local num = 0
    for _, v in pairs(Site.data) do
        local Possible = true
        ID = tostring(v.id)
        if tonumber(v.maxPlayers) > tonumber(v.playing) then
            for _, Existing in pairs(AllIDs) do
                if num ~= 0 then
                    if ID == tostring(Existing) then
                        Possible = false
                    end
                else
                    if tonumber(actualHour) ~= tonumber(Existing) then
                        AllIDs = {}
                        table.insert(AllIDs, actualHour)
                    end
                end
                num = num + 1
            end
            if Possible == true then
                table.insert(AllIDs, ID)
                
                print(string.format("[Lithium] Found server: %s (%d/%d players)", ID, v.playing, v.maxPlayers))
                
                -- ✅ Сохраняем конфиг перед телепортом
                SaveConfig()
                
                -- ✅ Телепортируемся с обработкой ошибок
                local teleportSuccess = pcall(function()
                    game:GetService("TeleportService"):TeleportToPlaceInstance(PlaceID, ID, LocalPlayer)
                end)
                
                if teleportSuccess then
                    print("[Lithium] ✓ Teleport initiated")
                    task.wait(10)  -- ✅ Увеличили до 10 секунд
                    return
                else
                    warn("[Lithium] ✗ Teleport failed")
                end
            end
        end
    end
end


local function Teleport()
    if not Config.ServerHop then
        print("[Lithium] Server Hop disabled")
        return
    end
    
    if isTeleporting then
        print("[Lithium] Already teleporting, please wait...")
        return
    end
    
    isTeleporting = true
    
    print("[Lithium] ═══════════════════════════════")
    print("[Lithium] Starting Server Hop...")
    print("[Lithium] Saving config...")
    SaveConfig()
    
    -- ✅ Очистка памяти перед телепортом
    print("[Lithium] Cleaning memory...")
    pcall(function()
        -- Отключаем ESP
        for player, billboard in pairs(ESPObjects) do
            if billboard then
                billboard:Destroy()
            end
        end
        ESPObjects = {}
        
        -- Собираем мусор
        collectgarbage("collect")
    end)
    
    task.wait(1)
    
    -- ✅ Обработчик неудачного телепорта
    local teleportConnection
    teleportConnection = game:GetService("TeleportService").TeleportInitFailed:Connect(function(humanoid, teleportResult, errorMessage)
        print("[Lithium] ⚠️ Teleport failed:", errorMessage)
        print("[Lithium] Retrying in 5 seconds...")
        task.wait(5)
        isTeleporting = false
        if teleportConnection then
            teleportConnection:Disconnect()
        end
    end)
    
    local maxAttempts = 5
    local currentAttempt = 0
    
    while currentAttempt < maxAttempts do
        currentAttempt = currentAttempt + 1
        print(string.format("[Lithium] Attempt %d/%d", currentAttempt, maxAttempts))
        
        local success = pcall(function()
            TPReturner()
            if foundAnything ~= "" then
                TPReturner()
            end
        end)
        
        if success then
            print("[Lithium] ✓ Teleport request sent!")
            print("[Lithium] Waiting for teleport...")
            print("[Lithium] ═══════════════════════════════")
            
            -- ✅ Ждём 10 секунд - либо телепорт пройдёт, либо нет
            task.wait(10)
            break
        else
            warn("[Lithium] ✗ Teleport attempt failed")
            
            if currentAttempt < maxAttempts then
                print(string.format("[Lithium] Waiting 3 seconds before retry..."))
                task.wait(3)
            end
        end
    end
    
    if currentAttempt >= maxAttempts then
        warn("[Lithium] ═══════════════════════════════")
        warn("[Lithium] ERROR: Failed to hop after 5 attempts")
        warn("[Lithium] Please restart the script")
        warn("[Lithium] ═══════════════════════════════")
    end
    
    if teleportConnection then
        teleportConnection:Disconnect()
    end
    
    isTeleporting = false
end

local function TeleportToTradeHub()
    local TradeHubID = 12807820316
    print("[Lithium] Teleporting to Trade Hub...")
    
    SaveConfig()
    
    TeleportService:Teleport(TradeHubID, LocalPlayer)
end

local function UseRandomServerButton()
    print("[Lithium] ═══════════════════════════════")
    print("[Lithium] Attempting to use RandomServer button...")
    
    local success = pcall(function()
        local randomServerButton = workspace:FindFirstChild("Map2")
        
        if randomServerButton then
            randomServerButton = randomServerButton:FindFirstChild("TeleportButtons")
            if randomServerButton then
                randomServerButton = randomServerButton:FindFirstChild("RandomServer")
                if randomServerButton then
                    randomServerButton = randomServerButton:FindFirstChild("Part")
                    
                    if randomServerButton and HRP then
                        print("[Lithium] ✓ Found RandomServer button!")
                        print("[Lithium] Current position: " .. tostring(HRP.Position))
                        
                        HRP.CFrame = randomServerButton.CFrame
                        print("[Lithium] ✓ Teleported to button position: " .. tostring(randomServerButton.Position))
                        print("[Lithium] Waiting 2 seconds...")
                        task.wait(2)
                        
                        print("[Lithium] Holding E for 2 seconds...")
                        game:GetService("VirtualInputManager"):SendKeyEvent(true, Enum.KeyCode.E, false, game)
                        task.wait(2)
                        game:GetService("VirtualInputManager"):SendKeyEvent(false, Enum.KeyCode.E, false, game)
                        
                        print("[Lithium] ✓ Button activated! Waiting for server switch...")
                        print("[Lithium] ═══════════════════════════════")
                        return true
                    end
                end
            end
        end
        
        warn("[Lithium] ERROR: RandomServer button not found!")
        print("[Lithium] ═══════════════════════════════")
        return false
    end)
    
    if not success then
        warn("[Lithium] Failed to use RandomServer button!")
        print("[Lithium] ═══════════════════════════════")
    end
end

local function CheckAllPlayerSkins(targetSkin)
    print("═══════════════════════════════")
    print(string.format("[Lithium] Searching for skin: '%s'", targetSkin))
    print(string.format("[Lithium] Total players on server: %d", #Players:GetPlayers()))
    
    local playersChecked = 0
    
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            playersChecked = playersChecked + 1
            
            local success, result = pcall(function()
                print(string.format("[Check %d] Checking player: %s", playersChecked, player.Name))
                
                local livingChar = workspace.Living:FindFirstChild(player.Name)
                
                if not livingChar then
                    print(string.format("  └─ No character in workspace.Living"))
                    return false
                end
                
                print(string.format("  └─ Character found in Living"))
                
                if not livingChar:FindFirstChild("StandMorph") then
                    print(string.format("  └─ No StandMorph"))
                    return false
                end
                
                print(string.format("  └─ StandMorph found"))
                
                local standMorph = livingChar.StandMorph
                
                if not standMorph:FindFirstChild("StandSkin") then
                    print(string.format("  └─ No StandSkin"))
                    return false
                end
                
                print(string.format("  └─ StandSkin found"))
                
                local skinValue = standMorph.StandSkin.Value
                
                if skinValue and skinValue ~= "" then
                    print(string.format("  └─ Skin Value: '%s'", skinValue))
                    
                    if skinValue == targetSkin then
                        print("  └─ ✓✓✓ MATCH! This is the target skin! ✓✓✓")
                        return true
                    else
                        print(string.format("  └─ Not a match (looking for '%s')", targetSkin))
                    end
                else
                    print(string.format("  └─ Skin Value is empty or nil"))
                end
                
                return false
            end)
            
            if success and result then
                print("═══════════════════════════════")
                print(string.format("[FOUND] Player: %s has skin: %s", player.Name, targetSkin))
                print("═══════════════════════════════")
                return true, player.Name
            end
        end
    end
    
    print(string.format("[Lithium] Checked %d players - skin not found", playersChecked))
    print("═══════════════════════════════")
    return false, nil
end

local function findItem(itemName)
    local ItemsDict = {
        ["Position"] = {},
        ["ProximityPrompt"] = {},
        ["Items"] = {}
    }
    
    for _, item in pairs(workspace["Item_Spawns"].Items:GetChildren()) do
        if item:FindFirstChild("MeshPart") and item:FindFirstChild("ProximityPrompt") then
            if item.ProximityPrompt.ObjectText == itemName then
                if item.ProximityPrompt.MaxActivationDistance == 8 then
                    table.insert(ItemsDict["Items"], item.ProximityPrompt.ObjectText)
                    table.insert(ItemsDict["ProximityPrompt"], item.ProximityPrompt)
                    table.insert(ItemsDict["Position"], item.MeshPart.CFrame)
                end
            end
        end
    end
    return ItemsDict
end

local function countItems(itemName)
    local itemAmount = 0
    for _, item in pairs(LocalPlayer.Backpack:GetChildren()) do
        if item.Name == itemName then
            itemAmount += 1
        end
    end
    return itemAmount
end

local function useItem(aItem, amount)
    task.wait()
    local item = LocalPlayer.Backpack:WaitForChild(aItem, 5)
    
    if not item then
        if Config.ServerHop then
            Teleport()
        end
        return
    end
    
    task.wait(0.2)
    if amount then
        Character.Humanoid:EquipTool(item)
        RemoteFunction:InvokeServer("LearnSkill", {["Skill"] = "Worthiness", ["SkillTreeType"] = "Character"})
        repeat
            item:Activate()
            task.wait()
        until LocalPlayer.PlayerGui:FindFirstChild("DialogueGui")
        
        task.wait(0.2)
        firesignal(LocalPlayer.PlayerGui:WaitForChild("DialogueGui").Frame.ClickContinue.MouseButton1Click)
        task.wait(0.2)
        firesignal(LocalPlayer.PlayerGui:WaitForChild("DialogueGui").Frame.Options:WaitForChild("Option1").TextButton.MouseButton1Click)
        task.wait(0.2)
        firesignal(LocalPlayer.PlayerGui:WaitForChild("DialogueGui").Frame.ClickContinue.MouseButton1Click)
        task.wait(0.2)
        repeat
            task.wait()
        until LocalPlayer.PlayerGui:WaitForChild("DialogueGui").Frame.DialogueFrame.Frame.Line001.Container.Group001.Text == "You"
        task.wait(0.2)
        firesignal(LocalPlayer.PlayerGui:WaitForChild("DialogueGui").Frame.ClickContinue.MouseButton1Click)
        task.wait(0.2)
    end
end

local function getitem(item, itemIndex)
    local gotItem = false
    local timeout = Config.WaitUntilCollect + 5

    if Character:FindFirstChild("SummonedStand") then
        if Character:FindFirstChild("SummonedStand").Value then
            RemoteFunction:InvokeServer("ToggleStand", "Toggle")
            task.wait(0.3)
        end
    end

    local connection
    connection = LocalPlayer.Backpack.ChildAdded:Connect(function()
        gotItem = true
        if connection then
            connection:Disconnect()
        end
    end)
    
    task.spawn(function()
        local firstTeleport = true
        while not gotItem do
            pcall(function()
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                    HRP.CFrame = item["Position"][itemIndex] - Vector3.new(0, 5, 0)
                    
                    if firstTeleport then
                        task.wait(0.3)
                        task.spawn(function()
                            game:GetService("VirtualInputManager"):SendKeyEvent(true, Enum.KeyCode.E, false, game)
                            task.wait(1.0)
                            game:GetService("VirtualInputManager"):SendKeyEvent(false, Enum.KeyCode.E, false, game)
                        end)
                        firstTeleport = false
                        task.wait(1.2)
                    end
                end
            end)
            task.wait(0.05)
        end
    end)

    task.wait(Config.WaitUntilCollect)

    task.spawn(function()
        for attempt = 1, 20 do
            if gotItem then break end
            pcall(function()
                fireproximityprompt(item["ProximityPrompt"][itemIndex])
            end)
            task.wait(0.05)
        end
    end)
    
    task.spawn(function()
        task.wait(0.2)
        
        local screenGui = LocalPlayer.PlayerGui:WaitForChild("ScreenGui", 3)
        if not screenGui then return end

        local screenGuiPart = screenGui:FindFirstChild("Part")
        if not screenGuiPart then return end
        
        for _, button in pairs(screenGuiPart:GetDescendants()) do
            if gotItem then break end
            
            if button:FindFirstChild("Part") then
                if button:IsA("ImageButton") and button.Part.TextColor3 == Color3.new(0, 1, 0) then
                    for i = 1, 40 do
                        if gotItem or not LocalPlayer.PlayerGui:FindFirstChild("ScreenGui") then break end
                        
                        pcall(function()
                            firesignal(button.MouseEnter)
                            firesignal(button.MouseButton1Up)
                            firesignal(button.MouseButton1Click)
                            firesignal(button.Activated)
                        end)
                        
                        task.wait(0.03)
                    end
                    break
                end
            end
        end
    end)
    
    task.spawn(function()
        task.wait(timeout)
        if not gotItem then
            gotItem = true
        end
    end)

    while not gotItem do
        task.wait(0.05)
    end
    
    if connection then
        connection:Disconnect()
    end
end

local function farmItem(itemName, amount)
    local items = findItem(itemName)
    local amountFirst = countItems(itemName) == amount

    for itemIndex, _ in pairs(items["Position"]) do
        if countItems(itemName) >= amount or amountFirst then
            break
        else
            getitem(items, itemIndex)
            task.wait(1)
        end
    end
    
    return true
end

local function endDialogue(NPC, Dialogue, Option)
    local dialogueToEnd = {
        ["NPC"] = NPC,
        ["Dialogue"] = Dialogue,
        ["Option"] = Option
    }
    RemoteEvent:FireServer("EndDialogue", dialogueToEnd)
end

local function storyDialogue()
    local Quest = {
        ["Storyline"] = {"#1", "#1", "#1", "#2", "#3", "#3", "#3", "#4", "#5", "#6", "#7", "#8", "#9", "#10", "#11", "#11", "#12", "#14"},
        ["Dialogue"] = {"Dialogue2", "Dialogue6", "Dialogue6", "Dialogue3", "Dialogue3", "Dialogue3", "Dialogue6", "Dialogue3", "Dialogue5", "Dialogue5", "Dialogue5", "Dialogue4", "Dialogue7", "Dialogue6", "Dialogue8", "Dialogue11", "Dialogue3", "Dialogue2"}
    }
    
    for counter = 1, 18, 1 do
        RemoteEvent:FireServer("EndDialogue", {
            ["NPC"] = "Storyline" .. " " .. Quest["Storyline"][counter],
            ["Dialogue"] = Quest["Dialogue"][counter],
            ["Option"] = "Option1"
        })
    end
end

local function isStandSkin()
    if not Character:FindFirstChild("SummonedStand") or not Character:FindFirstChild("SummonedStand").Value then
        RemoteFunction:InvokeServer("ToggleStand", "Toggle")
        task.wait(2.5)
    else
        task.wait(1)
    end
    
    local livingChar = workspace.Living:FindFirstChild(LocalPlayer.Name)
    if livingChar and livingChar:FindFirstChild("StandMorph") then
        local standMorph = livingChar.StandMorph
        
        if standMorph:FindFirstChild("StandSkin") then
            local skinValue = standMorph.StandSkin.Value
            
            if skinValue and skinValue ~= "" then
                print(string.format("[Stand Check] ✓ SKIN: %s", tostring(skinValue)))
                return true, tostring(skinValue)
            end
        end
    end
    
    return false, nil
end

local function buyLuckyArrow()
    local success, result = pcall(function()
        local itemButton = LocalPlayer.PlayerGui.HUD.Main.Frames.Store.List.ItemShop.List:FindFirstChild("1x Lucky Arrow")
        
        if not itemButton then
            return false
        end
        
        for i = 1, 5 do
            pcall(function()
                firesignal(itemButton.MouseButton1Down)
                firesignal(itemButton.MouseButton1Up)
                firesignal(itemButton.MouseButton1Click)
                firesignal(itemButton.Activated)
            end)
            task.wait(0.1)
        end
        
        task.wait(2)
        
        local confirmButton = LocalPlayer.PlayerGui.HUD.Main.Frames.Store.Confirmation:WaitForChild("Yes", 3)
        
        if not confirmButton then
            return false
        end
        
        for i = 1, 5 do
            pcall(function()
                firesignal(confirmButton.MouseButton1Down)
                firesignal(confirmButton.MouseButton1Up)
                firesignal(confirmButton.MouseButton1Click)
                firesignal(confirmButton.Activated)
            end)
            task.wait(0.1)
        end
        
        return true
    end)
    
    return success
end

local function killTarget(targetName, playerDistance, dontDestroyOnKill, extraParameters, isPlayer)
    local Target
    
    if isPlayer then
        Target = Players:FindFirstChild(targetName)
        if not Target or not Target.Character or not Target.Character:FindFirstChild("HumanoidRootPart") then
            return false
        end
        Target = Target.Character
    else
        Target = workspace.Living:WaitForChild(targetName, Config.NPCTimeOut)
        if not Target then
            if Config.ServerHop then
                Teleport()
            end
            return false
        end
    end
    
    local beingTargeted = true
    local doneKilled = false
    local deadCheck
    
    local function setStandMorphPosition()
        pcall(function()
            if not Target or not Target:FindFirstChild("HumanoidRootPart") then return end
            
            if LocalPlayer.PlayerStats.Stand.Value == "None" then
                HRP.CFrame = Target.HumanoidRootPart.CFrame - Vector3.new(0, 5, 0)
                return
            end
            
            if not Character:FindFirstChild("SummonedStand").Value or not Character:FindFirstChild("StandMorph") then
                RemoteFunction:InvokeServer("ToggleStand", "Toggle")
                return
            end
            
            Character.StandMorph.PrimaryPart.CFrame = Target.HumanoidRootPart.CFrame + Target.HumanoidRootPart.CFrame.lookVector * -1.1
            HRP.CFrame = Character.StandMorph.PrimaryPart.CFrame + Character.StandMorph.PrimaryPart.CFrame.lookVector - Vector3.new(0, playerDistance, 0)
            
            if not Character:FindFirstChild("FocusCam") then
                local FocusCam = Instance.new("ObjectValue", Character)
                FocusCam.Name = "FocusCam"
                FocusCam.Value = Character.StandMorph.PrimaryPart
            end
            
            if Character:FindFirstChild("FocusCam") and Character.FocusCam.Value ~= Character.StandMorph.PrimaryPart then
                Character.FocusCam.Value = Character.StandMorph.PrimaryPart
            end
        end)
    end
    
    local function HamonCharge()
        if not Character:FindFirstChild("Hamon") then return end
        
        if Character.Hamon.Value <= Config.HamonCharge then
            RemoteFunction:InvokeServer("AssignSkillKey", {
                ["Type"] = "Spec",
                ["Key"] = "Enum.KeyCode.L",
                ["Skill"] = "Hamon Breathing"
            })
            Character.RemoteEvent:FireServer("InputBegan", {["Input"] = Enum.KeyCode.L})
        end
    end
    
    local function BlockBreaker()
        if not Target or Target.Parent == nil then return end
        
        local humanoid = Target:FindFirstChild("Humanoid")
        if not humanoid then return end
        
        if game:GetService("CollectionService"):HasTag(Target, "Blocking") then
            RemoteEvent:FireServer("InputBegan", {["Input"] = Enum.KeyCode.R})
        elseif humanoid.Health <= 1 then
            task.spawn(function()
                task.wait(5)
                if Target then
                    RemoteFunction:InvokeServer("Attack", "m1")
                end
            end)
        elseif humanoid.Health >= 1 then
            RemoteFunction:InvokeServer("Attack", "m1")
        end
    end
    
    if not isPlayer then
        deadCheck = LocalPlayer.PlayerGui.HUD.Main.DropMoney.Money.ChildAdded:Connect(function(child)
            local number = tonumber(string.match(child.Name, "%d+"))
            
            if number and Target then
                doneKilled = true
                deadCheck:Disconnect()
                
                if not dontDestroyOnKill then
                    Target:Destroy()
                end
            end
        end)
    else
        task.spawn(function()
            while beingTargeted and Target do
                local humanoid = Target:FindFirstChild("Humanoid")
                if not humanoid or humanoid.Health <= 0 then
                    doneKilled = true
                    beingTargeted = false
                    break
                end
                task.wait(1)
            end
        end)
    end
    
    while beingTargeted do
        task.wait()
        
        if not Target or not Target.Parent or not Target:FindFirstChild("HumanoidRootPart") then
            if deadCheck then deadCheck:Disconnect() end
            beingTargeted = false
            break
        end
        
        if extraParameters then
            extraParameters()
        end
        
        task.spawn(setStandMorphPosition)
        task.spawn(HamonCharge)
        task.spawn(BlockBreaker)
    end
    
    return doneKilled
end

local function killNPC(npcName, playerDistance, dontDestroyOnKill, extraParameters)
    return killTarget(npcName, playerDistance, dontDestroyOnKill, extraParameters, false)
end

local function allocateSkills()
    task.spawn(function()
        RemoteFunction:InvokeServer("LearnSkill", {["Skill"] = "Destructive Power V", ["SkillTreeType"] = "Stand"})
        RemoteFunction:InvokeServer("LearnSkill", {["Skill"] = "Destructive Power IV", ["SkillTreeType"] = "Stand"})
        RemoteFunction:InvokeServer("LearnSkill", {["Skill"] = "Destructive Power III", ["SkillTreeType"] = "Stand"})
        RemoteFunction:InvokeServer("LearnSkill", {["Skill"] = "Destructive Power II", ["SkillTreeType"] = "Stand"})
        RemoteFunction:InvokeServer("LearnSkill", {["Skill"] = "Destructive Power I", ["SkillTreeType"] = "Stand"})
        
        if LocalPlayer.PlayerStats.Spec.Value == "Hamon (William Zeppeli)" then
            RemoteFunction:InvokeServer("LearnSkill", {["Skill"] = "Hamon Punch V", ["SkillTreeType"] = "Spec"})
            RemoteFunction:InvokeServer("LearnSkill", {["Skill"] = "Lung Capacity V", ["SkillTreeType"] = "Spec"})
            RemoteFunction:InvokeServer("LearnSkill", {["Skill"] = "Breathing Technique V", ["SkillTreeType"] = "Spec"})
        end
    end)
end

local function attemptStandFarm()
    if not LocalPlayer or not Character or not HRP then
        return
    end
    
    HRP.CFrame = CFrame.new(500, 2010, 500)
    
    if LocalPlayer.PlayerStats and LocalPlayer.PlayerStats.Stand and LocalPlayer.PlayerStats.Stand.Value == "None" then
        useItem("Mysterious Arrow", "II")
        
        repeat
            task.wait(0.5)
        until LocalPlayer.PlayerStats.Stand.Value ~= "None"
        
        if not Config.StandList[LocalPlayer.PlayerStats.Stand.Value] then
            useItem("Rokakaka", "II")
        elseif Config.StandList[LocalPlayer.PlayerStats.Stand.Value] then
            dontTPOnDeath = true
            if Config.ServerHop then
                Teleport()
            end
        end
    elseif LocalPlayer.PlayerStats and LocalPlayer.PlayerStats.Stand and LocalPlayer.PlayerStats.Stand.Value ~= "None" then
        if not Config.StandList[LocalPlayer.PlayerStats.Stand.Value] then
            useItem("Rokakaka", "II")
        end
    end
end

local function checkPrestige(level, prestige)
    if (level == 35 and prestige == 0) or (level == 40 and prestige == 1) or (level == 45 and prestige == 2) then
        endDialogue("Prestige", "Dialogue2", "Option1")
        return true
    else
        return false
    end
end

local lastTick = tick()

-- ✅ ИДЕАЛЬНАЯ ЛОГИКА FULL STORY - ИСПРАВЛЕННАЯ ВЕРСИЯ
local function autoStory()
    local questPanel = LocalPlayer.PlayerGui.HUD.Main.Frames.Quest.Quests
    local repeatCount = 0
    allocateSkills()

    -- ═══════════════════════════════════════
    -- 1. ДЕБАГ - ПОКАЗЫВАЕМ ИНФОРМАЦИЮ
    -- ═══════════════════════════════════════
    print("[Lithium] ═══════════════════════════════")
    print(string.format("[Lithium] Full Story State: %s", Config.FullStoryState))
    print(string.format("[Lithium] Current Level: %d", LocalPlayer.PlayerStats.Level.Value))
    print(string.format("[Lithium] Current Stand: %s", LocalPlayer.PlayerStats.Stand.Value))
    print(string.format("[Lithium] Current Spec: %s", LocalPlayer.PlayerStats.Spec.Value))
    print("[Lithium] Active Quests:")
    for _, quest in pairs(questPanel:GetChildren()) do
        if quest:IsA("TextLabel") or quest:IsA("TextButton") then
            print("  - " .. tostring(quest.Text or quest.Name))
        end
    end
    print("[Lithium] ═══════════════════════════════")

    -- ═══════════════════════════════════════
    -- 2. ПРОВЕРКА УРОВНЯ 50+ = СТОП
    -- ═══════════════════════════════════════
    if LocalPlayer.PlayerStats.Level.Value >= 50 then
        print("[Lithium] Level 50+ reached! Full Story complete!")
        Config.FullStory = false
        Config.FullStoryState = "idle"
        SaveConfig()
        
        if Character:FindFirstChild("FocusCam") then
            Character.FocusCam:Destroy()
        end
        return
    end

    -- ═══════════════════════════════════════
    -- 3. ВОССТАНОВЛЕНИЕ ПОСЛЕ SERVER HOP
    -- ═══════════════════════════════════════
    if Config.FullStoryState == "farming_items" then
        print("[Lithium] Resuming item farming...")
        
        local arrowCount = countItems("Mysterious Arrow")
        local rokaCount = countItems("Rokakaka")
        
        if arrowCount >= 25 and rokaCount >= 25 then
            Config.FullStoryState = "farming_stand"
            SaveConfig()
        else
            if arrowCount < 25 then
                farmItem("Mysterious Arrow", 25)
            end
            if rokaCount < 25 then
                farmItem("Rokakaka", 25)
            end
            farmItem("Zeppeli's Hat", 1)
            
            if countItems("Mysterious Arrow") >= 25 and countItems("Rokakaka") >= 25 then
                Config.FullStoryState = "farming_stand"
                SaveConfig()
                attemptStandFarm()
            else
                if Config.ServerHop then
                    Teleport()
                end
            end
        end
        return
    end

    if Config.FullStoryState == "farming_stand" then
        print("[Lithium] Resuming stand farming...")
        
        if Config.StandList[LocalPlayer.PlayerStats.Stand.Value] then
            Config.FullStoryState = "idle"
            SaveConfig()
        else
            attemptStandFarm()
        end
        return
    end

    -- ═══════════════════════════════════════
    -- 4. REQUIEM ARROW (УРОВЕНЬ 25+, PRESTIGE 1+)
    -- ═══════════════════════════════════════
    if LocalPlayer.PlayerStats.Level.Value >= 25 
        and LocalPlayer.PlayerStats.Prestige.Value >= 1 
        and LocalPlayer.Backpack:FindFirstChild("Requiem Arrow") 
        and (LocalPlayer.PlayerStats.Stand.Value == "King Crimson" or LocalPlayer.PlayerStats.Stand.Value == "Star Platinum") then
        
        print("[Lithium] Using Requiem Arrow...")
        HRP.CFrame = CFrame.new(500, 2010, 500)
        local oldStand = LocalPlayer.PlayerStats.Stand.Value
        useItem("Requiem Arrow", "V")
        repeat
            task.wait()
        until LocalPlayer.PlayerStats.Stand.Value ~= oldStand
        return
    end

    -- ═══════════════════════════════════════
    -- 5. ПОЛУЧЕНИЕ HAMON (УРОВЕНЬ 25+)
    -- ═══════════════════════════════════════
    if LocalPlayer.PlayerStats.Spec.Value == "None" and LocalPlayer.PlayerStats.Level.Value >= 25 then
        print("[Lithium] Getting Hamon...")
        
        local function collectAndSell(toolName, amount)
            farmItem(toolName, amount)
            Character.Humanoid:EquipTool(LocalPlayer.Backpack:FindFirstChild(toolName))
            endDialogue("Merchant", "Dialogue5", "Option2")
        end
        
        if LocalPlayer.PlayerStats.Money.Value <= 10000 then
            collectAndSell("Mysterious Arrow", 25)
            collectAndSell("Rokakaka", 25)
            collectAndSell("Diamond", 10)
            collectAndSell("Steel Ball", 10)
        end
        
        if not LocalPlayer.Backpack:FindFirstChild("Zeppeli's Hat") then
            task.wait(30)
            farmItem("Zeppeli's Hat", 1)
            
            if not LocalPlayer.Backpack:FindFirstChild("Zeppeli's Hat") then
                task.wait(60)
                return
            end
        end

        if LocalPlayer.Backpack:FindFirstChild("Zeppeli's Hat") then
            Character.Humanoid:EquipTool(LocalPlayer.Backpack:FindFirstChild("Zeppeli's Hat"))
            LocalPlayer.Character.RemoteEvent:FireServer("PromptTriggered", game.ReplicatedStorage.NewDialogue:FindFirstChild("Lisa Lisa"))
            
            repeat
                game:GetService("VirtualInputManager"):SendMouseButtonEvent(0, 8, 0, true, nil, 1)
                task.wait(0.05)
            until LocalPlayer.PlayerGui:FindFirstChild("DialogueGui")
            
            if LocalPlayer.PlayerGui:FindFirstChild("DialogueGui") then
                repeat
                    game:GetService("VirtualInputManager"):SendMouseButtonEvent(0, 8, 0, true, nil, 1)
                    task.wait(0.05)
                until LocalPlayer.PlayerGui:FindFirstChild("DialogueGui").Frame.Options:FindFirstChild("Option1")
            end
            
            firesignal(LocalPlayer.PlayerGui:FindFirstChild("DialogueGui").Frame.Options.Option1.TextButton.MouseButton1Click)
            repeat
                firesignal(LocalPlayer.PlayerGui:FindFirstChild("DialogueGui").Frame.ClickContinue.MouseButton1Click)
                task.wait(0.05)
            until LocalPlayer.PlayerGui:FindFirstChild("DialogueGui").Frame.Options:FindFirstChild("Option1")
            
            if LocalPlayer.PlayerGui:FindFirstChild("DialogueGui").Frame.Options:FindFirstChild("Option1") then
                firesignal(LocalPlayer.PlayerGui:FindFirstChild("DialogueGui").Frame.Options.Option1.TextButton.MouseButton1Click)
            end
            
            repeat
                firesignal(LocalPlayer.PlayerGui:FindFirstChild("DialogueGui").Frame.ClickContinue.MouseButton1Click)
                task.wait(0.05)
            until LocalPlayer.PlayerGui:FindFirstChild("DialogueGui").Frame.Options:FindFirstChild("Option1")
            
            if LocalPlayer.PlayerGui:FindFirstChild("DialogueGui").Frame.Options:FindFirstChild("Option1") then
                firesignal(LocalPlayer.PlayerGui:FindFirstChild("DialogueGui").Frame.Options.Option1.TextButton.MouseButton1Click)
            end
            
            task.wait(10)
            return
        else
            if Config.ServerHop then
                Teleport()
            else
                task.wait(30)
                return
            end
        end
    end

        -- ═══════════════════════════════════════
        -- 6. БЕРЁМ ДОСТУПНЫЕ КВЕСТЫ (КАК В ОРИГИНАЛЕ)
        -- ═══════════════════════════════════════
        print("[Lithium] Taking available quests...")

        while #questPanel:GetChildren() < 2 and repeatCount < 1000 do
            -- Проверяем квест на вампиров (если уровень 25+ и есть Hamon)
            if LocalPlayer.PlayerStats.Level.Value >= 25 
                and LocalPlayer.PlayerStats.Spec.Value ~= "None" 
                and not questPanel:FindFirstChild("Take down 3 vampires") then
                
                lastTick = tick()
                endDialogue("William Zeppeli", "Dialogue4", "Option1")
            end
            
            LocalPlayer.QuestsRemoteFunction:InvokeServer({[1] = "ReturnData"})
            storyDialogue()
            task.wait(0.1)  -- ✅ Быстро, как в оригинале!
            repeatCount = repeatCount + 1
        end

        if repeatCount >= 1000 then
            print("[Lithium] ERROR: Couldn't get quests - server hopping...")
            if Config.ServerHop then
                Teleport()
            end
            return
        end

        -- ═══════════════════════════════════════
        -- ДЕБАГ: Показываем текущие квесты
        -- ═══════════════════════════════════════
        print("[Lithium] Current quests:")
        for _, quest in pairs(questPanel:GetChildren()) do
            if quest:IsA("TextLabel") or quest:IsA("TextButton") then
                local text = quest.Text or quest.Name or ""
                if text ~= "UIListLayout" and text ~= "" then
                    print("  - " .. text)
                end
            end
        end
        print("[Lithium] ═══════════════════════════════")

    -- ═══════════════════════════════════════
    -- 7. ПРОВЕРКА КВЕСТОВ ПО ПРИОРИТЕТУ
    -- ═══════════════════════════════════════
    
    -- 7.1 Quest: Help Giorno (Security Guard)
    if questPanel:FindFirstChild("Help Giorno by Defeating Security Guards") then
        print("[Lithium] Quest: Help Giorno - Security Guard")
        if killNPC("Security Guard", 15) then
            task.wait(1)
            storyDialogue()
            task.wait(1)
        end
        return
    end

    -- 7.2 ФАРМ СТЕНДА (ТОЛЬКО ДО 25 УРОВНЯ!)
    if not Config.StandList[LocalPlayer.PlayerStats.Stand.Value] 
        and LocalPlayer.PlayerStats.Level.Value >= 3 
        and LocalPlayer.PlayerStats.Level.Value < 25 
        and dontTPOnDeath then
        
        print("[Lithium] Need to farm stand (Level < 25)...")
        
        local arrowCount = countItems("Mysterious Arrow")
        local rokaCount = countItems("Rokakaka")
        
        if Config.StandList[LocalPlayer.PlayerStats.Stand.Value] then
            print("[Lithium] ✓ Got target stand! Continuing story...")
            Config.FullStoryState = "idle"
            SaveConfig()
            dontTPOnDeath = true
            return
        end
        
        if arrowCount >= 25 and rokaCount >= 25 then
            Config.FullStoryState = "farming_stand"
            SaveConfig()
            dontTPOnDeath = false
            attemptStandFarm()
        else
            Config.FullStoryState = "farming_items"
            SaveConfig()
            
            if arrowCount < 25 then
                farmItem("Mysterious Arrow", 25)
            end
            if rokaCount < 25 then
                farmItem("Rokakaka", 25)
            end
            farmItem("Zeppeli's Hat", 1)

            if countItems("Mysterious Arrow") >= 25 and countItems("Rokakaka") >= 25 then
                Config.FullStoryState = "farming_stand"
                SaveConfig()
                dontTPOnDeath = false
                attemptStandFarm()
            else
                if Config.ServerHop then
                    Teleport()
                end
            end
        end
        return
    end

    -- 7.3 Quest: Defeat Leaky Eye Luca
    if questPanel:FindFirstChild("Defeat Leaky Eye Luca") and Config.StandList[LocalPlayer.PlayerStats.Stand.Value] then
        print("[Lithium] Quest: Defeat Leaky Eye Luca")
        if killNPC("Leaky Eye Luca", 15) then
            task.wait(1)
            storyDialogue()
            task.wait(1)
        end
        return
    end

    -- 7.4 Quest: Defeat Bucciarati
    if questPanel:FindFirstChild("Defeat Bucciarati") then
        print("[Lithium] Quest: Defeat Bucciarati")
        if killNPC("Bucciarati", 15) then
            task.wait(1)
            storyDialogue()
            task.wait(1)
        end
        return
    end

    -- 7.5 Quest: Collect $5,000
    if questPanel:FindFirstChild("Collect $5,000 To Cover For Popo's Real Fortune") then
        print("[Lithium] Quest: Collect $5,000")
        if LocalPlayer.PlayerStats.Money.Value < 5000 then
            local function collectAndSell(toolName, amount)
                if countItems(toolName) <= amount then
                    farmItem(toolName, amount)
                    Character.Humanoid:EquipTool(LocalPlayer.Backpack:FindFirstChild(toolName))
                    endDialogue("Merchant", "Dialogue5", "Option2")
                    task.wait(1)
                    storyDialogue()
                end
                
                if LocalPlayer.PlayerStats.Money.Value >= 5000 then
                    storyDialogue()
                    task.wait(1)
                end
            end
            
            task.wait(10)
            collectAndSell("Mysterious Arrow", 25)
            collectAndSell("Rokakaka", 25)
            collectAndSell("Diamond", 10)
            collectAndSell("Steel Ball", 10)
        else
            storyDialogue()
            task.wait(1)
        end
        return
    end

    -- 7.6 Quest: Defeat Fugo
    if questPanel:FindFirstChild("Defeat Fugo And His Purple Haze") then
        print("[Lithium] Quest: Defeat Fugo")
        if killNPC("Fugo", 15) then
            task.wait(1)
            storyDialogue()
            task.wait(1)
        end
        return
    end

    -- 7.7 Quest: Defeat Pesci
    if questPanel:FindFirstChild("Defeat Pesci") then
        print("[Lithium] Quest: Defeat Pesci")
        if killNPC("Pesci", 15) then
            task.wait(1)
            storyDialogue()
            task.wait(1)
        end
        return
    end

    -- 7.8 Quest: Defeat Ghiaccio
    if questPanel:FindFirstChild("Defeat Ghiaccio") then
        print("[Lithium] Quest: Defeat Ghiaccio")
        if killNPC("Ghiaccio", 15) then
            task.wait(1)
            storyDialogue()
            task.wait(1)
        end
        return
    end

    -- 7.9 Quest: Defeat Diavolo
    if questPanel:FindFirstChild("Defeat Diavolo") then
        print("[Lithium] Quest: Defeat Diavolo")
        if killNPC("Diavolo", 15) then
            task.wait(1)
            endDialogue("Storyline #14", "Dialogue7", "Option1")
            task.wait(1)
            storyDialogue()
            task.wait(1)
        end
        
        if Character:WaitForChild("Requiem Arrow", 5) then
            Character.Humanoid.Health = 0
            
            if Config.ServerHop then
                Teleport()
            else
                repeat task.wait(1) until Character and Character.Parent and Character:FindFirstChild("Humanoid") and Character.Humanoid.Health > 0
                task.wait(3)
                return
            end
        else
            return
        end
    end

    -- 7.10 Quest: Take down 3 vampires (ВАЖНО: Только если есть Hamon)
    if questPanel:FindFirstChild("Take down 3 vampires") 
        and LocalPlayer.PlayerStats.Spec.Value ~= "None" 
        and LocalPlayer.PlayerStats.Level.Value >= 25 then
        
        print("[Lithium] Quest: Take down 3 vampires")
        Config.HamonCharge = 10
        
        local function vampire()
            HRP.CFrame = workspace.Living:FindFirstChild("Vampire").HumanoidRootPart.CFrame - Vector3.new(0, 15, 0)
            if not questPanel:FindFirstChild("Take down 3 vampires") then
                if (tick() - lastTick) >= 5 then
                    lastTick = tick()
                end
                endDialogue("William Zeppeli", "Dialogue4", "Option1")
            end
        end
        
        killNPC("Vampire", 15, false, vampire)
        return

-- ═══════════════════════════════════════
    -- 8. ДЕФОЛТНОЕ ДЕЙСТВИЕ - УМНЫЙ ФАРМ
    -- ═══════════════════════════════════════
    else
        print("[Lithium] ═══════════════════════════════")
        print("[Lithium] No matching quest found!")
        print("[Lithium] Retaking quests...")
        
        -- Пытаемся взять квесты заново
        for i = 1, 5 do
            -- Специально берём квест на вампиров если нужен
            if LocalPlayer.PlayerStats.Level.Value >= 25 
                and LocalPlayer.PlayerStats.Spec.Value ~= "None" then
                endDialogue("William Zeppeli", "Dialogue4", "Option1")
            end
            storyDialogue()
            task.wait(0.5)
        end
        
        -- Проверяем, появились ли квесты
        local hasActiveQuest = false
        print("[Lithium] Checking for quests after retry:")
        for _, quest in pairs(questPanel:GetChildren()) do
            if quest:IsA("TextLabel") or quest:IsA("TextButton") then
                local text = quest.Text or ""
                if text ~= "UIListLayout" and text ~= "" then
                    hasActiveQuest = true
                    print("  ✓ Found: " .. text)
                end
            end
        end
        
        if hasActiveQuest then
            print("[Lithium] Found quests - rerunning autoStory()...")
            print("[Lithium] ═══════════════════════════════")
            return  -- Вернёмся в цикл, autoStory() вызовется снова
        end
        
        -- Если квестов нет - фармим по уровню
        print("[Lithium] Still no quests - farming by level...")
        
        local targetMob = "Vampire"  -- Дефолт для 25+
        
        if LocalPlayer.PlayerStats.Level.Value < 5 then
            targetMob = "Security Guard"
        elseif LocalPlayer.PlayerStats.Level.Value < 15 then
            targetMob = "Leaky Eye Luca"
        elseif LocalPlayer.PlayerStats.Level.Value < 20 then
            targetMob = "Bucciarati"
        elseif LocalPlayer.PlayerStats.Level.Value < 25 then
            targetMob = "Fugo"
        else
            -- ✅ На 25+ ВСЕГДА вампиры!
            targetMob = "Vampire"
            Config.HamonCharge = 10
        end
        
        print(string.format("[Lithium] Target: %s (Level %d)", targetMob, LocalPlayer.PlayerStats.Level.Value))
        print("[Lithium] ═══════════════════════════════")
        
        if killNPC(targetMob, 15) then
            task.wait(1)
        end
        
        return
    end
end

-- ═══════════════════════════════════════
-- ESP FUNCTIONS
-- ═══════════════════════════════════════

local function CreateESP(player)
    if player == LocalPlayer then return end
    
    if ESPObjects[player] then
        ESPObjects[player]:Destroy()
    end
    
    local BillboardGui = Instance.new("BillboardGui")
    BillboardGui.Name = "ESP_" .. player.Name
    BillboardGui.Size = UDim2.new(0, 100, 0, 50)
    BillboardGui.StudsOffset = Vector3.new(0, 2, 0)
    BillboardGui.AlwaysOnTop = true
    BillboardGui.Parent = CoreGui
    
    local TextLabel = Instance.new("TextLabel")
    TextLabel.BackgroundTransparency = 1
    TextLabel.Size = UDim2.new(1, 0, 1, 0)
    TextLabel.Font = Enum.Font.GothamBold
    TextLabel.TextColor3 = Colors.Accent
    TextLabel.TextStrokeTransparency = 0
    TextLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    TextLabel.TextSize = 14
    TextLabel.Text = player.Name
    TextLabel.Parent = BillboardGui
    
    ESPObjects[player] = BillboardGui
    
    local connection
    connection = RunService.Heartbeat:Connect(function()
        if not Config.PlayerESP or not ESPObjects[player] then
            if connection then
                connection:Disconnect()
            end
            return
        end
        
        pcall(function()
            if not player or not player.Parent or not player.Character then
                BillboardGui.Enabled = false
                return
            end
            
            local hrp = player.Character:FindFirstChild("HumanoidRootPart")
            if not hrp then
                BillboardGui.Enabled = false
                return
            end
            
            local myChar = LocalPlayer.Character
            if not myChar then
                BillboardGui.Enabled = false
                return
            end
            
            local myHRP = myChar:FindFirstChild("HumanoidRootPart")
            if not myHRP then
                BillboardGui.Enabled = false
                return
            end
            
            BillboardGui.Adornee = hrp
            BillboardGui.Enabled = true
            
            local distance = (myHRP.Position - hrp.Position).Magnitude
            
            if Config.ShowDistance then
                TextLabel.Text = player.Name .. "\n[" .. math.floor(distance) .. " studs]"
            else
                TextLabel.Text = player.Name
            end
        end)
    end)
    
    player.CharacterAdded:Connect(function()
        task.wait(1)
        if ESPObjects[player] and player.Character then
            local hrp = player.Character:WaitForChild("HumanoidRootPart", 5)
            if hrp then
                BillboardGui.Adornee = hrp
                BillboardGui.Enabled = true
            end
        end
    end)
end

local function RemoveESP(player)
    if ESPObjects[player] then
        ESPObjects[player]:Destroy()
        ESPObjects[player] = nil
    end
end

-- ═══════════════════════════════════════
-- AUTOFARM LOOPS
-- ═══════════════════════════════════════

task.spawn(function()
    while task.wait(3) do
        if Config.MobFarm and Config.SelectedMob then
            pcall(function()
                killNPC(Config.SelectedMob, 15)
            end)
        end
    end
end)

task.spawn(function()
    while task.wait(5) do
        if Config.StandFarm then
            pcall(function()
                local arrowCount = countItems("Mysterious Arrow")
                local rokaCount = countItems("Rokakaka")
                
                if arrowCount < Config.MinArrows and arrowCount < 25 then
                    farmItem("Mysterious Arrow", Config.MinArrows)
                    task.wait(2)
                end
                
                if rokaCount < Config.MinRokas and rokaCount < 25 then
                    farmItem("Rokakaka", Config.MinRokas)
                    task.wait(2)
                end
                
                arrowCount = countItems("Mysterious Arrow")
                rokaCount = countItems("Rokakaka")
                
                if arrowCount >= 1 and rokaCount >= 1 then
                    HRP.CFrame = CFrame.new(500, 2010, 500)
                    task.wait(1)
                    
                    if LocalPlayer.PlayerStats.Stand.Value == "None" then
                        useItem("Mysterious Arrow", "II")
                        
                        repeat
                            task.wait(0.5)
                        until LocalPlayer.PlayerStats.Stand.Value ~= "None"
                        
                        task.wait(1)
                    end
                    
                    if LocalPlayer.PlayerStats.Stand.Value ~= "None" then
                        local currentStand = LocalPlayer.PlayerStats.Stand.Value
                        
                        local hasSkin, skinName = isStandSkin()
                        
                        if hasSkin and Config.StopOnSkin then
                            Config.StandFarm = false
                            
                            if Config.ServerHop then
                                Teleport()
                            end
                            return
                        end
                        
                        if currentStand == Config.TargetStand then
                            Config.StandFarm = false
                            
                            if Config.ServerHop then
                                Teleport()
                            end
                        else
                            useItem("Rokakaka", "II")
                            task.wait(2)
                        end
                    end
                else
                    task.wait(10)
                end
            end)
        end
    end
end)

local currentPlayerTarget = nil
local playerFarmActive = false

task.spawn(function()
    while task.wait() do
        if Config.PlayerFarm and Config.TargetPlayer then
            local targetPlayer = Players:FindFirstChild(Config.TargetPlayer)
            
            if targetPlayer and targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart") then
                if currentPlayerTarget ~= Config.TargetPlayer or not playerFarmActive then
                    currentPlayerTarget = Config.TargetPlayer
                    playerFarmActive = true
                    
                    pcall(function()
                        killTarget(Config.TargetPlayer, 15, false, nil, true)
                    end)
                    
                    playerFarmActive = false
                end
            end
        else
            currentPlayerTarget = nil
            playerFarmActive = false
        end
    end
end)

task.spawn(function()
    while task.wait(5) do
        if Config.ItemAutofarm and #Config.SelectedItems > 0 then
            pcall(function()
                local itemsToFarm = {}
                
                if table.find(Config.SelectedItems, "All Items") then
                    for _, item in ipairs(ItemList) do
                        if item ~= "All Items" then
                            table.insert(itemsToFarm, item)
                        end
                    end
                else
                    itemsToFarm = Config.SelectedItems
                end
                
                -- ✅ НОВАЯ ЛОГИКА: Проверка наличия предметов на сервере
                if Config.ItemServerHop then
                    local foundAnyItem = false
                    
                    -- Проверяем, есть ли хотя бы один предмет из списка
                    for _, itemName in ipairs(itemsToFarm) do
                        local items = findItem(itemName)
                        if #items["Position"] > 0 then
                            foundAnyItem = true
                            print(string.format("[Lithium] ✓ Found %s on server", itemName))
                            break
                        end
                    end
                    
                    -- Если НИ ОДНОГО предмета нет - хопаем
                    if not foundAnyItem then
                        print("[Lithium] ═══════════════════════════════")
                        print("[Lithium] No items found on server!")
                        print("[Lithium] Server hopping...")
                        print("[Lithium] ═══════════════════════════════")
                        
                        SaveConfig()
                        Teleport()
                        return
                    end
                end
                
                -- Фармим доступные предметы
                for _, itemName in ipairs(itemsToFarm) do
                    if Config.ItemAutofarm then
                        local items = findItem(itemName)
                        
                        for itemIndex, _ in pairs(items["Position"]) do
                            if Config.ItemAutofarm then
                                getitem(items, itemIndex)
                                task.wait(1)
                            else
                                break
                            end
                        end
                    end
                end
            end)
        end
    end
end)

task.spawn(function()
    while task.wait(5) do
        if Config.AutoSell and #Config.SellItems > 0 then
            pcall(function()
                local itemsToSell = {}
                
                if table.find(Config.SellItems, "All Items") then
                    for _, item in ipairs(ItemList) do
                        -- ✅ Пропускаем "All Items" и защищенные предметы
                        if item ~= "All Items" and not table.find(ProtectedItems, item) then
                            table.insert(itemsToSell, item)
                        end
                    end
                else
                    itemsToSell = Config.SellItems
                end
                
                for _, itemName in ipairs(itemsToSell) do
                    -- ✅ ПРОВЕРКА: Защищен ли предмет?
                    if table.find(ProtectedItems, itemName) then
                        print(string.format("[Lithium] ⚠️ Protected item skipped: %s", itemName))
                        continue  -- Пропускаем этот предмет
                    end
                    
                    if LocalPlayer.Backpack:FindFirstChild(itemName) or Character:FindFirstChild(itemName) then
                        print(string.format("[Lithium] Selling: %s", itemName))
                        
                        if LocalPlayer.Backpack:FindFirstChild(itemName) then
                            Character.Humanoid:EquipTool(LocalPlayer.Backpack:FindFirstChild(itemName))
                        end
                        task.wait(0.5)
                        endDialogue("Merchant", "Dialogue5", "Option2")
                        task.wait(0.5)
                    end
                end
            end)
        end
    end
end)

task.spawn(function()
    while task.wait(60) do
        if Config.AutoBuyArrows then
            pcall(function()
                buyLuckyArrow()
            end)
        end
    end
end)

local function SendWebhook(skinName, playerName)
    if Config.Webhook == "" or not Config.Webhook then
        return
    end
    
    pcall(function()
        local jobId = game.JobId
        local placeId = game.PlaceId
        
        local data = {
            ["embeds"] = {{
                ["title"] = "🎯 SKIN FOUND!",
                ["description"] = string.format(
                    "**Skin:** %s\n**Player:** %s\n**JobId:** `%s`\n**PlaceId:** %s",
                    skinName,
                    playerName,
                    jobId,
                    placeId
                ),
                ["color"] = 65280,
                ["timestamp"] = os.date("!%Y-%m-%dT%H:%M:%S"),
                ["footer"] = {
                    ["text"] = "Lithium Hub v0.0.3 (PERFECT)"
                }
            }}
        }
        
        local success = request({
            Url = Config.Webhook,
            Method = "POST",
            Headers = {
                ["Content-Type"] = "application/json"
            },
            Body = HttpService:JSONEncode(data)
        })
        
        if success then
            print("[Lithium] Webhook sent successfully!")
        end
    end)
end

task.spawn(function()
    print("[Lithium] Trading loop starting...")
    print("[Lithium] Waiting 15 seconds for full initialization...")
    task.wait(15)
    
    if not Config.SkinSearch then
        print("[Lithium] Skin search is disabled - trading loop stopped")
        return
    end
    
    print("[Lithium] Skin search enabled - starting loop")
    
    local isChecking = false
    
    while true do
        task.wait(5)
        
        if Config.SkinSearch and not isChecking then
            isChecking = true
            
            local currentPlaceId = game.PlaceId
            print("═══════════════════════════════")
            print(string.format("[Lithium] PlaceId: %d", currentPlaceId))
            
            if currentPlaceId ~= 12807820316 then
                print("[Lithium] ERROR: Not in Trade Hub!")
                print("[Lithium] Please manually go to Trade Hub and restart script")
                print("═══════════════════════════════")
                Config.SkinSearch = false
                SaveConfig()
                isChecking = false
                break
            end
            
            print("[Lithium] ✓ In Trade Hub")
            
            local targetSkin = Config.CustomSkin ~= "" and Config.CustomSkin or Config.TargetSkin
            
            if targetSkin == "None" or targetSkin == "" then
                print("[Lithium] ERROR: No target skin selected!")
                print("═══════════════════════════════")
                isChecking = false
                task.wait(10)
            else
                print(string.format("[Lithium] Target: '%s'", targetSkin))
                print("[Lithium] Starting player scan in 3 seconds...")
                print("═══════════════════════════════")
                task.wait(3)
                
                local found, playerName = CheckAllPlayerSkins(targetSkin)
                
                if found then
                    print("╔═══════════════════════════════╗")
                    print("║     ✓✓✓ SKIN FOUND! ✓✓✓       ║")
                    print("╚═══════════════════════════════╝")
                    print(string.format("Player: %s", playerName))
                    print(string.format("Skin: %s", targetSkin))
                    print(string.format("JobId: %s", game.JobId))
                    print("═══════════════════════════════")
                    
                    SendWebhook(targetSkin, playerName)
                    
                    Config.SkinSearch = false
                    SaveConfig()
                    
                    print("[Lithium] Staying on this server!")
                    isChecking = false
                    break
                else
                    print("[Lithium] Skin not found - switching servers...")
                    print("═══════════════════════════════")
                    
                    task.wait(2)
                    
                    UseRandomServerButton()
                    
                    print("[Lithium] Waiting 30 seconds for new server to load...")
                    task.wait(30)
                    
                    isChecking = false
                    print("[Lithium] Ready for next check")
                end
            end
        end
    end
end)

task.spawn(function()
    while task.wait(3) do
        if LocalPlayer.PlayerStats.Level.Value >= 50 then
            if Character:FindFirstChild("FocusCam") then
                Character.FocusCam:Destroy()
            end
            break
        end
        
        if checkPrestige(LocalPlayer.PlayerStats.Level.Value, LocalPlayer.PlayerStats.Prestige.Value) then
            endDialogue("Prestige", "Dialogue2", "Option1")
            task.wait(2)
            
            if Config.ServerHop then
                Teleport()
            end
            
            task.wait(5)
        end
    end
end)

workspace.Living.ChildAdded:Connect(function(character)
    if character.Name == LocalPlayer.Name then
        if LocalPlayer.PlayerStats.Level.Value < 50 then
            if dontTPOnDeath then
                if Config.ServerHop then
                    Teleport()
                end
            else
                attemptStandFarm()
            end
        end
    end
end)

task.spawn(function()
    while task.wait(30) do
        SaveConfig()
    end
end)

-- ═══════════════════════════════════════
-- STEEL BALL RUN FUNCTIONS
-- ═══════════════════════════════════════

local function ClickSBRButton()
    local success = pcall(function()
        local loadingScreen = LocalPlayer.PlayerGui:FindFirstChild("LoadingScreen")
        
        if not loadingScreen then
            warn("[Lithium] LoadingScreen not found!")
            return false
        end
        
        local frames = loadingScreen:FindFirstChild("Frames")
        if not frames then
            warn("[Lithium] Frames not found!")
            return false
        end
        
        -- ✅ ШАГ 1: Нажимаем кнопку SBR в GameModes
        print("[Lithium] Step 1: Clicking SBR button in GameModes...")
        
        local gamemodesFrame = frames:FindFirstChild("Gamemodes")
        if not gamemodesFrame then
            warn("[Lithium] Gamemodes frame not found!")
            return false
        end
        
        local gameModesScroll = gamemodesFrame:FindFirstChild("GameModes")
        if not gameModesScroll then
            warn("[Lithium] GameModes not found!")
            return false
        end
        
        local scrollingFrame = gameModesScroll:FindFirstChild("ScrollingFrame")
        if not scrollingFrame then
            warn("[Lithium] ScrollingFrame not found!")
            return false
        end
        
        local sbrButton = scrollingFrame:FindFirstChild("SBR")
        if not sbrButton then
            warn("[Lithium] SBR button not found!")
            return false
        end
        
        print("[Lithium] ✓ Found SBR button")
        
        for i = 1, 5 do
            pcall(function()
                firesignal(sbrButton.MouseButton1Down)
                firesignal(sbrButton.MouseButton1Up)
                firesignal(sbrButton.MouseButton1Click)
                firesignal(sbrButton.Activated)
            end)
            task.wait(0.1)
        end
        
        print("[Lithium] ✓ Clicked SBR button")
        
        -- ✅ ШАГ 2: Ждем 1 секунду
        print("[Lithium] Waiting 1 second...")
        task.wait(1)
        
        -- ✅ ШАГ 3: Нажимаем Ranked или Normal
        print(string.format("[Lithium] Step 2: Clicking %s button...", Config.SBRMode))
        
        local sbrFrame = frames:FindFirstChild("SteelBallRun")
        if not sbrFrame then
            warn("[Lithium] SteelBallRun frame not found!")
            return false
        end
        
        local modeButton
        if Config.SBRMode == "Normal" then
            modeButton = sbrFrame:FindFirstChild("Normal")
        else
            modeButton = sbrFrame:FindFirstChild("Ranked")
        end
        
        if not modeButton then
            warn("[Lithium] Mode button not found!")
            return false
        end
        
        local playButton = modeButton:FindFirstChild("Play")
        if not playButton then
            warn("[Lithium] Play button not found!")
            return false
        end
        
        print(string.format("[Lithium] ✓ Found %s.Play button", Config.SBRMode))
        
        for i = 1, 5 do
            pcall(function()
                firesignal(playButton.MouseButton1Down)
                firesignal(playButton.MouseButton1Up)
                firesignal(playButton.MouseButton1Click)
                firesignal(playButton.Activated)
            end)
            task.wait(0.1)
        end
        
        print(string.format("[Lithium] ✓ Clicked %s.Play button", Config.SBRMode))
        
        return true
    end)
    
    return success
end


-- ═══════════════════════════════════════
-- AUTO SBR LOOP
-- ═══════════════════════════════════════

task.spawn(function()
    while task.wait(5) do
        -- ✅ ПРОВЕРКА: Включен ли Auto SBR?
        if not Config.AutoSBR then
            task.wait(5)
            continue
        end
        
        -- ✅ Auto SBR включен - работаем!
        pcall(function()
            local currentPlaceId = game.PlaceId
            
            print("[Lithium] ═══════════════════════════════")
            print(string.format("[Lithium] PlaceId: %d", currentPlaceId))
            print(string.format("[Lithium] AutoSBR: %s", tostring(Config.AutoSBR)))
            print(string.format("[Lithium] JoinSBR: %s", tostring(Config.JoinSBR)))
            
            -- ✅ Проверка 1: Мы в Metal Ball Run - запускаем фарм!
            if currentPlaceId == 4643697430 then
                print("[Lithium] ✓ In Metal Ball Run!")
                print("[Lithium] ═══════════════════════════════")
                
                -- ✅ ЗАПУСКАЕМ АВТОФАРМ
                AutoSBRFarm()
                
                -- После завершения фарма ждём телепорт
                task.wait(30)
                return
            end
            
            -- ✅ Проверка 2: Мы в Your Bizarre Adventure
            if currentPlaceId == 2809202155 then
                print("[Lithium] ✓ In Your Bizarre Adventure")
                
                -- ✅ Если JoinSBR = false, устанавливаем true и реджойним
                if not Config.JoinSBR then
                    print("[Lithium] JoinSBR = false")
                    print("[Lithium] Setting JoinSBR = true and teleporting...")
                    print("[Lithium] ═══════════════════════════════")
                    
                    Config.JoinSBR = true
                    SaveConfig()
                    
                    game:GetService("TeleportService"):Teleport(2809202155, LocalPlayer)
                    task.wait(30)
                    return
                end
                
                -- ✅ Если JoinSBR = true, значит мы вернулись после гонки
                -- Даём время кнопкам сработать (они уже были нажаты при загрузке)
                print("[Lithium] JoinSBR = true - waiting for SBR teleport...")
                print("[Lithium] Buttons were pressed on load, waiting 30 seconds...")
                print("[Lithium] ═══════════════════════════════")
                
                task.wait(30)
                
                -- Проверяем, телепортировались ли мы
                if game.PlaceId == 2809202155 then
                    -- Всё ещё в YBA - что-то пошло не так, пробуем снова
                    warn("[Lithium] Still in YBA after 30 seconds - rejoining...")
                    game:GetService("TeleportService"):Teleport(2809202155, LocalPlayer)
                    task.wait(30)
                end
                
                return
            end
            
            -- ✅ Проверка 3: Мы в другой игре - телепортируемся в YBA
            print("[Lithium] Not in YBA or Metal Ball Run!")
            print("[Lithium] Teleporting to YBA...")
            print("[Lithium] ═══════════════════════════════")
            
            Config.JoinSBR = true
            SaveConfig()
            
            game:GetService("TeleportService"):Teleport(2809202155, LocalPlayer)
            task.wait(30)
        end)
    end
end)

-- ═══════════════════════════════════════
-- CREATE GUI
-- ═══════════════════════════════════════

CreateLoadingScreen()
task.wait(4)

local Window = Library:CreateWindow("LITHIUM HUB")

local DashboardTab = Window:CreateTab("Dashboard", "📊")

DashboardTab:CreateLabel("═══ Welcome to Lithium Hub ═══")
DashboardTab:CreateLabel("")
DashboardTab:CreateLabel("v0.0.3 (PERFECT)")
DashboardTab:CreateLabel("")
DashboardTab:CreateLabel("✓ 10 sec LoadingScreen wait")
DashboardTab:CreateLabel("✓ Perfect Full Story logic")
DashboardTab:CreateLabel("✓ Auto-resume after Server Hop")
DashboardTab:CreateLabel("✓ Debug output for all quests")
DashboardTab:CreateLabel("✓ Default mob farming")
DashboardTab:CreateLabel("")
DashboardTab:CreateLabel("Features:")
DashboardTab:CreateLabel("• Apple Glass Design")
DashboardTab:CreateLabel("• Trading - Skin Search")
DashboardTab:CreateLabel("• Auto Save/Load")
DashboardTab:CreateLabel("• Full Story Autofarm")
DashboardTab:CreateLabel("• Stand Farm")
DashboardTab:CreateLabel("• Player Targeting")
DashboardTab:CreateLabel("• Item Farming")
DashboardTab:CreateLabel("• Player ESP")

local AutofarmTab = Window:CreateTab("Autofarm", "🎯")

AutofarmTab:CreateLabel("═══ Full Story Mode ═══")

local FullStoryToggle = AutofarmTab:CreateToggle("Full Story", Config.FullStory, function(value)
    Config.FullStory = value
    SaveConfig()
    
    if value then
        task.spawn(function()
            while Config.FullStory do
                if LocalPlayer.PlayerStats.Level.Value >= 50 then
                    Config.FullStory = false
                    FullStoryToggle:Set(false)
                    SaveConfig()
                    break
                end
                
                pcall(function()
                    autoStory()
                end)
                
                task.wait(2)
                
                if not Config.FullStory then
                    break
                end
            end
        end)
    end
end)

local ServerHopToggle = AutofarmTab:CreateToggle("Server Hop", Config.ServerHop, function(value)
    Config.ServerHop = value
    SaveConfig()
end)

AutofarmTab:CreateLabel("═══ Stand Farm ═══")

local StandFarmToggle = AutofarmTab:CreateToggle("Enable Stand Farm", Config.StandFarm, function(value)
    Config.StandFarm = value
    SaveConfig()
end)

local TargetStandDropdown = AutofarmTab:CreateDropdown("Target Stand", AllStandsList, Config.TargetStand, function(value)
    Config.TargetStand = value
    SaveConfig()
end)

local StopOnSkinToggle = AutofarmTab:CreateToggle("Stop on Skin", Config.StopOnSkin, function(value)
    Config.StopOnSkin = value
    SaveConfig()
end)

AutofarmTab:CreateLabel("═══ Mob Farm ═══")

local MobFarmToggle = AutofarmTab:CreateToggle("Enable Mob Farm", Config.MobFarm, function(value)
    Config.MobFarm = value
    SaveConfig()
end)

local MobDropdown = AutofarmTab:CreateDropdown("Select Mob", MobList, Config.SelectedMob, function(value)
    Config.SelectedMob = value
    SaveConfig()
end)

local CombatTab = Window:CreateTab("Combat", "⚔️")

CombatTab:CreateLabel("═══ Player Targeting ═══")

local PlayerFarmToggle = CombatTab:CreateToggle("Attack Target Player", Config.PlayerFarm, function(value)
    Config.PlayerFarm = value
    SaveConfig()
end)

local function getPlayerList()
    local playerNames = {}
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            table.insert(playerNames, player.Name)
        end
    end
    return playerNames
end

local PlayerDropdown = CombatTab:CreateDropdown("Select Player", getPlayerList(), Config.TargetPlayer or "None", function(value)
    Config.TargetPlayer = value
    SaveConfig()
end)

Players.PlayerAdded:Connect(function()
    task.wait(1)
    PlayerDropdown:Refresh(getPlayerList())
end)

Players.PlayerRemoving:Connect(function()
    task.wait(1)
    PlayerDropdown:Refresh(getPlayerList())
end)


local ItemsTab = Window:CreateTab("Items", "📦")

ItemsTab:CreateLabel("═══ Item Farming ═══")

local ItemFarmToggle = ItemsTab:CreateToggle("Item Autofarm", Config.ItemAutofarm, function(value)
    Config.ItemAutofarm = value
    SaveConfig()
end)

local ItemMultiDropdown = ItemsTab:CreateMultiDropdown("Select Items to Farm", ItemList, Config.SelectedItems, function(values)
    Config.SelectedItems = values
    SaveConfig()
end)

local ItemServerHopToggle = ItemsTab:CreateToggle("Item Server Hop", Config.ItemServerHop, function(value)
    Config.ItemServerHop = value
    SaveConfig()
end)

ItemsTab:CreateLabel("═══ Auto Sell ═══")

local AutoSellToggle = ItemsTab:CreateToggle("Auto Sell", Config.AutoSell, function(value)
    Config.AutoSell = value
    SaveConfig()
end)

local SellMultiDropdown = ItemsTab:CreateMultiDropdown("Select Items to Sell", ItemList, Config.SellItems, function(values)
    Config.SellItems = values
    SaveConfig()
end)

ItemsTab:CreateLabel("═══ Auto Buy Lucky Arrows ═══")

local AutoBuyToggle = ItemsTab:CreateToggle("Auto Buy Lucky Arrows", Config.AutoBuyArrows, function(value)
    Config.AutoBuyArrows = value
    SaveConfig()
end)

-- ═══════════════════════════════════════
-- SBR TAB
-- ═══════════════════════════════════════

local SBRTab = Window:CreateTab("SBR", "🏁")

SBRTab:CreateLabel("═══ Steel Ball Run ═══")

local AutoSBRToggle = SBRTab:CreateToggle("Full Auto SBR", Config.AutoSBR, function(value)
    Config.AutoSBR = value
    SaveConfig()
    
    if value then
        -- ✅ При включении устанавливаем флаг и телепортируемся
        print("[Lithium] Auto SBR enabled!")
        print("[Lithium] Setting JoinSBR = true...")
        
        Config.JoinSBR = true
        SaveConfig()
        
        print("[Lithium] Teleporting to YBA...")
        TeleportService:Teleport(2809202155, LocalPlayer)
    else
        -- ✅ При выключении сбрасываем флаг
        print("[Lithium] Auto SBR disabled!")
        Config.JoinSBR = false
        SaveConfig()
    end
end)

local SBRModeDropdown = SBRTab:CreateDropdown("Mode", {"Normal", "Ranked"}, Config.SBRMode, function(value)
    Config.SBRMode = value
    SaveConfig()
end)

SBRTab:CreateLabel("")
SBRTab:CreateLabel("How it works:")
SBRTab:CreateLabel("1. Script checks if you're in YBA")
SBRTab:CreateLabel("2. Clicks Normal or Ranked button")
SBRTab:CreateLabel("3. Selects topmost server")
SBRTab:CreateLabel("4. Auto-joins the race!")

local TradingTab = Window:CreateTab("Trading", "💼")

TradingTab:CreateLabel("═══ Skin Search (Trade Hub) ═══")

local SkinSearchToggle = TradingTab:CreateToggle("Search for Skin", Config.SkinSearch, function(value)
    Config.SkinSearch = value
    SaveConfig()
    
    if value then
        print("[Lithium] Skin search enabled!")
        
        if game.PlaceId ~= 12807820316 then
            print("[Lithium] Not in Trade Hub - teleporting...")
            TeleportToTradeHub()
        else
            print("[Lithium] Already in Trade Hub - starting search!")
        end
    else
        print("[Lithium] Skin search disabled")
    end
end)

local SkinDropdown = TradingTab:CreateDropdown("Select Skin", SkinsList, Config.TargetSkin, function(value)
    Config.TargetSkin = value
    SaveConfig()
end)

local CustomSkinBox = TradingTab:CreateTextBox("Custom Skin", Config.CustomSkin, "Enter custom skin name...", function(value)
    Config.CustomSkin = value
    SaveConfig()
end)

local WebhookBox = TradingTab:CreateTextBox("Discord Webhook", Config.Webhook, "Paste webhook URL here...", function(value)
    Config.Webhook = value
    SaveConfig()
end)

TradingTab:CreateLabel("")
TradingTab:CreateLabel("How it works:")
TradingTab:CreateLabel("1. Select skin or enter custom name")
TradingTab:CreateLabel("2. Enable 'Search for Skin'")
TradingTab:CreateLabel("3. Script joins Trade Hub servers")
TradingTab:CreateLabel("4. Checks all players for the skin")
TradingTab:CreateLabel("5. Server hops until found!")

local MiscTab = Window:CreateTab("Misc", "⚙️")

MiscTab:CreateLabel("═══ Player ESP ═══")

local PlayerESPToggle = MiscTab:CreateToggle("Player ESP", Config.PlayerESP, function(value)
    Config.PlayerESP = value
    SaveConfig()
    
    if value then
        for _, player in ipairs(Players:GetPlayers()) do
            CreateESP(player)
        end
    else
        for player, _ in pairs(ESPObjects) do
            RemoveESP(player)
        end
    end
end)

local DistanceToggle = MiscTab:CreateToggle("Show Distance", Config.ShowDistance, function(value)
    Config.ShowDistance = value
    SaveConfig()
end)

Players.PlayerAdded:Connect(function(player)
    if Config.PlayerESP then
        player.CharacterAdded:Connect(function()
            task.wait(1)
            CreateESP(player)
        end)
    end
end)

Players.PlayerRemoving:Connect(function(player)
    RemoveESP(player)
end)

FullStoryToggle:Set(Config.FullStory)
ServerHopToggle:Set(Config.ServerHop)
StandFarmToggle:Set(Config.StandFarm)
StopOnSkinToggle:Set(Config.StopOnSkin)
MobFarmToggle:Set(Config.MobFarm)
PlayerFarmToggle:Set(Config.PlayerFarm)
ItemFarmToggle:Set(Config.ItemAutofarm)
AutoSellToggle:Set(Config.AutoSell)
AutoBuyToggle:Set(Config.AutoBuyArrows)
SkinSearchToggle:Set(Config.SkinSearch)
PlayerESPToggle:Set(Config.PlayerESP)
DistanceToggle:Set(Config.ShowDistance)

print("╔═══════════════════════════════════════╗")
print("║      LITHIUM HUB v0.0.3 (PERFECT)     ║")
print("║        Apple Glass Design             ║")
print("╚═══════════════════════════════════════╝")
print("")
print("✓ 10 sec LoadingScreen wait")
print("✓ Perfect Full Story logic")
print("✓ Auto-resume after Server Hop")
print("✓ Debug output for all quests")
print("✓ Default mob farming if stuck")
print("")
print("Ready!")
